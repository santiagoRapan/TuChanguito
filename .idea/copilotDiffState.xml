<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/navigation/IconsProbe.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/navigation/IconsProbe.kt" />
              <option name="originalContent" value="&#10;&#10;&#10;&#10;" />
              <option name="updatedContent" value="// Archivo de prueba temporal para verificar disponibilidad de íconos de Material.&#10;// Ya no se utiliza y se deja intencionalmente vacío para evitar imports innecesarios." />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/screens/home/HomeScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/screens/home/HomeScreen.kt" />
              <option name="originalContent" value="package com.example.tuchanguito.ui.screens.home&#10;&#10;import androidx.compose.animation.core.FastOutSlowInEasing&#10;import androidx.compose.animation.core.animateFloatAsState&#10;import androidx.compose.animation.core.tween&#10;import androidx.compose.foundation.BorderStroke&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Box&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.ColumnScope&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxSize&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.height&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.rounded.Add&#10;import androidx.compose.material.icons.rounded.AddShoppingCart&#10;import androidx.compose.material.icons.rounded.Category&#10;import androidx.compose.material.icons.rounded.PlaylistAdd&#10;import androidx.compose.material.icons.filled.ArrowDropDown&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.ButtonDefaults&#10;import androidx.compose.material3.CenterAlignedTopAppBar&#10;import androidx.compose.material3.DropdownMenu&#10;import androidx.compose.material3.DropdownMenuItem&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.IconButton&#10;import androidx.compose.material3.LinearProgressIndicator&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedButton&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.Scaffold&#10;import androidx.compose.material3.SnackbarHost&#10;import androidx.compose.material3.SnackbarHostState&#10;import androidx.compose.material3.Surface&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextButton&#10;import androidx.compose.material3.TopAppBarDefaults&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.collectAsState&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.saveable.rememberSaveable&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.res.stringResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.text.style.TextAlign&#10;import androidx.compose.ui.unit.dp&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import com.example.tuchanguito.MyApplication&#10;import com.example.tuchanguito.R&#10;import com.example.tuchanguito.data.network.model.ShoppingListDto&#10;import com.example.tuchanguito.ui.theme.ButtonBlue&#10;import com.example.tuchanguito.ui.theme.ColorPrimary&#10;import com.example.tuchanguito.ui.theme.ColorPrimaryBorder&#10;import com.example.tuchanguito.ui.theme.PrimaryTextBlue&#10;import java.util.Locale&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HomeScreen(&#10;    onOpenList: (Long) -&gt; Unit,&#10;    onNewProduct: () -&gt; Unit,&#10;    onConfigureCategories: () -&gt; Unit,&#10;    onCreateList: () -&gt; Unit,&#10;) {&#10;    val context = LocalContext.current&#10;    val app = context.applicationContext as MyApplication&#10;    val viewModel: HomeViewModel = viewModel(&#10;        factory = remember(app.shoppingListsRepository, app.pantryRepository) {&#10;            HomeViewModelFactory(app.shoppingListsRepository, app.pantryRepository)&#10;        }&#10;    )&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val snackbarHost = remember { SnackbarHostState() }&#10;&#10;    LaunchedEffect(viewModel) {&#10;        viewModel.events.collect { event -&gt;&#10;            when (event) {&#10;                is HomeEvent.LowStockAdded -&gt; {&#10;                    val destination = event.listName ?: context.getString(R.string.home_low_stock_destination_fallback)&#10;                    val message = context.getString(&#10;                        R.string.home_low_stock_add,&#10;                        event.quantity,&#10;                        destination&#10;                    )&#10;                    snackbarHost.showSnackbar(message)&#10;                }&#10;                is HomeEvent.ShowError -&gt; {&#10;                    snackbarHost.showSnackbar(event.message)&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    var pendingLowStock by remember { mutableStateOf&lt;LowStockItemUi?&gt;(null) }&#10;    var selectedListId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;    var pendingQuantity by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;&#10;    LaunchedEffect(pendingLowStock, uiState.listOptions) {&#10;        if (pendingLowStock != null &amp;&amp; selectedListId == null &amp;&amp; uiState.listOptions.isNotEmpty()) {&#10;            selectedListId = uiState.listOptions.first().id&#10;        }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            CenterAlignedTopAppBar(&#10;                title = { Text(stringResource(id = R.string.app_name), color = Color.White) },&#10;                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(&#10;                    containerColor = ColorPrimary,&#10;                    titleContentColor = Color.White,&#10;                    navigationIconContentColor = Color.White,&#10;                    actionIconContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snackbarHost) },&#10;        containerColor = MaterialTheme.colorScheme.background,&#10;    ) { padding -&gt;&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .verticalScroll(rememberScrollState())&#10;                .padding(padding)&#10;                .padding(horizontal = 16.dp, vertical = 24.dp),&#10;            verticalArrangement = Arrangement.spacedBy(20.dp)&#10;        ) {&#10;            ActiveListSection(&#10;                active = uiState.activeList,&#10;                onOpenList = onOpenList,&#10;                onCreateList = onCreateList,&#10;                purchasedCount = uiState.activePurchasedCount,&#10;                totalCount = uiState.activeTotalCount,&#10;                progress = uiState.activeProgress&#10;            )&#10;            QuickActionsSection(onCreateList, onNewProduct, onConfigureCategories)&#10;            LowStockSection(&#10;                items = uiState.lowStockItems,&#10;                onAdd = { item -&gt;&#10;                    pendingLowStock = item&#10;                    selectedListId = uiState.listOptions.firstOrNull()?.id&#10;                    pendingQuantity = item.suggestedQuantity.toString()&#10;                }&#10;            )&#10;        }&#10;    }&#10;&#10;    val dialogItem = pendingLowStock&#10;    if (dialogItem != null) {&#10;        LowStockAddDialog(&#10;            item = dialogItem,&#10;            listOptions = uiState.listOptions,&#10;            selectedListId = selectedListId,&#10;            quantityText = pendingQuantity,&#10;            isProcessing = uiState.isProcessingLowStock,&#10;            onListSelected = { selectedListId = it },&#10;            onQuantityChange = { newValue -&gt; pendingQuantity = newValue.filter { ch -&gt; ch.isDigit() } },&#10;            onDismiss = {&#10;                if (!uiState.isProcessingLowStock) {&#10;                    pendingLowStock = null&#10;                    selectedListId = null&#10;                    pendingQuantity = &quot;&quot;&#10;                }&#10;            },&#10;            onConfirm = {&#10;                val targetList = selectedListId&#10;                val quantity = pendingQuantity.toIntOrNull()&#10;                    ?: dialogItem.suggestedQuantity&#10;                if (targetList != null) {&#10;                    viewModel.addLowStockItemToList(dialogItem.pantryItemId, targetList, quantity)&#10;                    pendingLowStock = null&#10;                    selectedListId = null&#10;                    pendingQuantity = &quot;&quot;&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun ActiveListSection(&#10;    active: ShoppingListDto?,&#10;    onOpenList: (Long) -&gt; Unit,&#10;    onCreateList: () -&gt; Unit,&#10;    purchasedCount: Int,&#10;    totalCount: Int,&#10;    progress: Float&#10;) {&#10;    HomeSectionCard(containerColor = ButtonBlue) {&#10;        Text(&#10;            text = stringResource(id = R.string.home_active_list_title),&#10;            style = MaterialTheme.typography.titleMedium,&#10;            color = Color.White,&#10;            fontWeight = FontWeight.SemiBold&#10;        )&#10;        Spacer(Modifier.height(12.dp))&#10;&#10;        if (active != null) {&#10;            Text(&#10;                text = active.name,&#10;                style = MaterialTheme.typography.titleLarge,&#10;                fontWeight = FontWeight.Bold,&#10;                color = Color.White&#10;            )&#10;            Spacer(Modifier.height(12.dp))&#10;&#10;            if (totalCount &gt; 0) {&#10;                // Contenedor blanco con esquinas redondeadas&#10;                Surface(&#10;                    color = Color.White,&#10;                    shape = RoundedCornerShape(12.dp),&#10;                    shadowElevation = 2.dp,&#10;                    modifier = Modifier.fillMaxWidth()&#10;                ) {&#10;                    Column(modifier = Modifier.padding(12.dp)) {&#10;                        Text(&quot;Progreso de la compra&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurface)&#10;                        Spacer(Modifier.height(6.dp))&#10;                        val animatedProgress by animateFloatAsState(&#10;                            targetValue = progress.coerceIn(0f, 1f),&#10;                            animationSpec = tween(durationMillis = 450, easing = FastOutSlowInEasing),&#10;                            label = &quot;homeActiveProgress&quot;&#10;                        )&#10;                        LinearProgressIndicator(&#10;                            progress = { animatedProgress },&#10;                            modifier = Modifier&#10;                                .fillMaxWidth()&#10;                                .height(8.dp),&#10;                            color = ButtonBlue,&#10;                            trackColor = Color.White&#10;                        )&#10;                        Spacer(Modifier.height(4.dp))&#10;                        val percent = (progress * 100).toInt()&#10;                        Text(&#10;                            text = &quot;$purchasedCount de $totalCount comprados ($percent%)&quot;,&#10;                            style = MaterialTheme.typography.labelSmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;                    }&#10;                }&#10;                Spacer(Modifier.height(12.dp))&#10;            }&#10;&#10;            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                Button(&#10;                    onClick = { onOpenList(active.id) },&#10;                    colors = ButtonDefaults.buttonColors(containerColor = Color.White, contentColor = ButtonBlue)&#10;                ) {&#10;                    Text(text = stringResource(id = R.string.home_active_list_open_button))&#10;                }&#10;            }&#10;        } else {&#10;            Text(&#10;                text = stringResource(id = R.string.home_active_list_empty_title),&#10;                style = MaterialTheme.typography.titleMedium,&#10;                fontWeight = FontWeight.SemiBold,&#10;                color = Color.White&#10;            )&#10;            Spacer(Modifier.height(24.dp))&#10;            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                OutlinedButton(&#10;                    onClick = onCreateList,&#10;                    colors = ButtonDefaults.outlinedButtonColors(contentColor = Color.White),&#10;                    border = BorderStroke(1.dp, Color.White.copy(alpha = 0.8f))&#10;                ) {&#10;                    Text(text = stringResource(id = R.string.home_create_list_button))&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun QuickActionsSection(&#10;    onCreateList: () -&gt; Unit,&#10;    onNewProduct: () -&gt; Unit,&#10;    onConfigureCategories: () -&gt; Unit&#10;) {&#10;    val actions = listOf(&#10;        QuickActionItem(&#10;            icon = Icons.Rounded.PlaylistAdd,&#10;            label = stringResource(id = R.string.home_quick_action_new_list_title),&#10;            onClick = onCreateList&#10;        ),&#10;        QuickActionItem(&#10;            icon = Icons.Rounded.AddShoppingCart,&#10;            label = stringResource(id = R.string.home_quick_action_new_product_title),&#10;            onClick = onNewProduct&#10;        ),&#10;        QuickActionItem(&#10;            icon = Icons.Rounded.Category,&#10;            label = stringResource(id = R.string.home_quick_action_categories_title),&#10;            onClick = onConfigureCategories&#10;        )&#10;    )&#10;&#10;    HomeSectionCard {&#10;        Text(&#10;            text = stringResource(id = R.string.home_quick_actions_title),&#10;            style = MaterialTheme.typography.titleMedium,&#10;            color = PrimaryTextBlue,&#10;            fontWeight = FontWeight.SemiBold&#10;        )&#10;        Spacer(Modifier.height(16.dp))&#10;        QuickActionsRow(actions = actions)&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun LowStockSection(&#10;    items: List&lt;LowStockItemUi&gt;,&#10;    onAdd: (LowStockItemUi) -&gt; Unit&#10;) {&#10;    HomeSectionCard {&#10;        Text(&#10;            text = stringResource(id = R.string.home_low_stock_title),&#10;            style = MaterialTheme.typography.titleMedium,&#10;            color = PrimaryTextBlue,&#10;            fontWeight = FontWeight.SemiBold&#10;        )&#10;        Spacer(Modifier.height(8.dp))&#10;        if (items.isEmpty()) {&#10;            Text(&#10;                text = stringResource(id = R.string.home_low_stock_empty),&#10;                style = MaterialTheme.typography.bodyMedium,&#10;                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;            )&#10;        } else {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                items.forEach { item -&gt;&#10;                    Row(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.SpaceBetween,&#10;                        verticalAlignment = Alignment.CenterVertically&#10;                    ) {&#10;                        Column(modifier = Modifier.weight(1f)) {&#10;                            val quantityDisplay = if ((item.currentQuantity % 1.0) == 0.0) {&#10;                                item.currentQuantity.toInt().toString()&#10;                            } else {&#10;                                String.format(Locale.getDefault(), &quot;%.1f&quot;, item.currentQuantity)&#10;                            }&#10;                            Text(&#10;                                text = item.name.ifBlank { stringResource(id = R.string.home_low_stock_unknown_product) },&#10;                                style = MaterialTheme.typography.bodyLarge,&#10;                                fontWeight = FontWeight.SemiBold&#10;                            )&#10;                            Text(&#10;                                text = &quot;$quantityDisplay ${item.unit} • mín. ${item.lowStockThreshold}&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                            )&#10;                        }&#10;                        IconButton(&#10;                            onClick = { onAdd(item) }&#10;                        ) {&#10;                            Icon(&#10;                                imageVector = Icons.Rounded.Add,&#10;                                contentDescription = stringResource(id = R.string.home_low_stock_add_button_content_desc),&#10;                                tint = ButtonBlue&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun HomeSectionCard(&#10;    modifier: Modifier = Modifier,&#10;    containerColor: Color = MaterialTheme.colorScheme.surface,&#10;    content: @Composable ColumnScope.() -&gt; Unit&#10;) {&#10;    Surface(&#10;        modifier = modifier.fillMaxWidth(),&#10;        shape = RoundedCornerShape(20.dp),&#10;        tonalElevation = 1.dp,&#10;        shadowElevation = 2.dp,&#10;        color = containerColor&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(20.dp),&#10;            content = content&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun QuickActionsRow(actions: List&lt;QuickActionItem&gt;) {&#10;    Row(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;    ) {&#10;        actions.forEach { action -&gt;&#10;            QuickActionCard(&#10;                modifier = Modifier.weight(1f),&#10;                action = action&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun QuickActionCard(&#10;    modifier: Modifier = Modifier,&#10;    action: QuickActionItem&#10;) {&#10;    Surface(&#10;        modifier = modifier.height(132.dp),&#10;        onClick = action.onClick,&#10;        shape = RoundedCornerShape(16.dp),&#10;        color = MaterialTheme.colorScheme.surface,&#10;        tonalElevation = 0.dp,&#10;        shadowElevation = 0.dp,&#10;        border = BorderStroke(1.dp, ColorPrimaryBorder)&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(16.dp),&#10;            verticalArrangement = Arrangement.SpaceBetween,&#10;            horizontalAlignment = Alignment.CenterHorizontally&#10;        ) {&#10;            Box(&#10;                modifier = Modifier&#10;                    .size(48.dp)&#10;                    .clip(RoundedCornerShape(24.dp))&#10;                    .background(ButtonBlue.copy(alpha = 0.15f)),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Icon(&#10;                    imageVector = action.icon,&#10;                    contentDescription = null,&#10;                    tint = ButtonBlue&#10;                )&#10;            }&#10;            Text(&#10;                text = action.label,&#10;                style = MaterialTheme.typography.bodySmall,&#10;                fontWeight = FontWeight.SemiBold,&#10;                textAlign = TextAlign.Center&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;private data class QuickActionItem(&#10;    val icon: androidx.compose.ui.graphics.vector.ImageVector,&#10;    val label: String,&#10;    val onClick: () -&gt; Unit&#10;)&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun LowStockAddDialog(&#10;    item: LowStockItemUi,&#10;    listOptions: List&lt;ShoppingListOption&gt;,&#10;    selectedListId: Long?,&#10;    quantityText: String,&#10;    isProcessing: Boolean,&#10;    onListSelected: (Long?) -&gt; Unit,&#10;    onQuantityChange: (String) -&gt; Unit,&#10;    onDismiss: () -&gt; Unit,&#10;    onConfirm: () -&gt; Unit&#10;) {&#10;    val hasLists = listOptions.isNotEmpty()&#10;    val isValidQuantity = quantityText.toIntOrNull()?.let { it &gt; 0 } == true&#10;    val confirmEnabled = hasLists &amp;&amp; selectedListId != null &amp;&amp; isValidQuantity &amp;&amp; !isProcessing&#10;    var expanded by remember { mutableStateOf(false) }&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!isProcessing) onDismiss() },&#10;        confirmButton = {&#10;            TextButton(onClick = { if (confirmEnabled) onConfirm() }, enabled = confirmEnabled) {&#10;                Text(text = stringResource(id = R.string.add))&#10;            }&#10;        },&#10;        dismissButton = {&#10;            TextButton(onClick = { if (!isProcessing) onDismiss() }) {&#10;                Text(text = stringResource(id = R.string.cancel))&#10;            }&#10;        },&#10;        title = { Text(text = stringResource(id = R.string.home_low_stock_dialog_title)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                val displayName = if (item.name.isNotBlank()) {&#10;                    item.name&#10;                } else {&#10;                    stringResource(id = R.string.home_low_stock_unknown_product)&#10;                }&#10;                Text(&#10;                    text = displayName,&#10;                    style = MaterialTheme.typography.bodyLarge,&#10;                    fontWeight = FontWeight.SemiBold&#10;                )&#10;                if (hasLists) {&#10;                    val selectedName = listOptions.firstOrNull { it.id == selectedListId }?.name.orEmpty()&#10;                    Box {&#10;                        OutlinedTextField(&#10;                            value = selectedName,&#10;                            onValueChange = {},&#10;                            readOnly = true,&#10;                            enabled = !isProcessing,&#10;                            label = { Text(stringResource(id = R.string.home_low_stock_select_list)) },&#10;                            trailingIcon = {&#10;                                Icon(&#10;                                    imageVector = Icons.Filled.ArrowDropDown,&#10;                                    contentDescription = null&#10;                                )&#10;                            },&#10;                            modifier = Modifier&#10;                                .fillMaxWidth()&#10;                                .clickable(enabled = !isProcessing) { expanded = true }&#10;                        )&#10;                        DropdownMenu(&#10;                            expanded = expanded,&#10;                            onDismissRequest = { expanded = false }&#10;                        ) {&#10;                            listOptions.forEach { option -&gt;&#10;                                DropdownMenuItem(&#10;                                    text = { Text(option.name) },&#10;                                    onClick = {&#10;                                        onListSelected(option.id)&#10;                                        expanded = false&#10;                                    }&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;                } else {&#10;                    Text(&#10;                        text = stringResource(id = R.string.home_low_stock_no_lists),&#10;                        style = MaterialTheme.typography.bodyMedium,&#10;                        color = MaterialTheme.colorScheme.error&#10;                    )&#10;                }&#10;                OutlinedTextField(&#10;                    value = quantityText,&#10;                    onValueChange = onQuantityChange,&#10;                    label = { Text(stringResource(id = R.string.home_low_stock_quantity_label)) },&#10;                    singleLine = true&#10;                )&#10;            }&#10;        }&#10;    )&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.tuchanguito.ui.screens.home&#10;&#10;import androidx.compose.animation.core.FastOutSlowInEasing&#10;import androidx.compose.animation.core.animateFloatAsState&#10;import androidx.compose.animation.core.tween&#10;import androidx.compose.foundation.BorderStroke&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Box&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.ColumnScope&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxSize&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.height&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.rounded.Add&#10;import androidx.compose.material.icons.rounded.AddShoppingCart&#10;import androidx.compose.material.icons.rounded.Category&#10;import androidx.compose.material.icons.rounded.PlaylistAdd&#10;import androidx.compose.material.icons.filled.ArrowDropDown&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.ButtonDefaults&#10;import androidx.compose.material3.CenterAlignedTopAppBar&#10;import androidx.compose.material3.DropdownMenu&#10;import androidx.compose.material3.DropdownMenuItem&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.IconButton&#10;import androidx.compose.material3.LinearProgressIndicator&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedButton&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.Scaffold&#10;import androidx.compose.material3.SnackbarHost&#10;import androidx.compose.material3.SnackbarHostState&#10;import androidx.compose.material3.Surface&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextButton&#10;import androidx.compose.material3.TopAppBarDefaults&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.collectAsState&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.saveable.rememberSaveable&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.res.stringResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.text.style.TextAlign&#10;import androidx.compose.ui.unit.dp&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import com.example.tuchanguito.MyApplication&#10;import com.example.tuchanguito.R&#10;import com.example.tuchanguito.data.network.model.ShoppingListDto&#10;import com.example.tuchanguito.ui.theme.ButtonBlue&#10;import com.example.tuchanguito.ui.theme.ColorPrimary&#10;import com.example.tuchanguito.ui.theme.ColorPrimaryBorder&#10;import com.example.tuchanguito.ui.theme.PrimaryTextBlue&#10;import java.util.Locale&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HomeScreen(&#10;    onOpenList: (Long) -&gt; Unit,&#10;    onNewProduct: () -&gt; Unit,&#10;    onConfigureCategories: () -&gt; Unit,&#10;    onCreateList: () -&gt; Unit,&#10;) {&#10;    val context = LocalContext.current&#10;    val app = context.applicationContext as MyApplication&#10;    val viewModel: HomeViewModel = viewModel(&#10;        factory = remember(app.shoppingListsRepository, app.pantryRepository) {&#10;            HomeViewModelFactory(app.shoppingListsRepository, app.pantryRepository)&#10;        }&#10;    )&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val snackbarHost = remember { SnackbarHostState() }&#10;&#10;    LaunchedEffect(viewModel) {&#10;        viewModel.events.collect { event -&gt;&#10;            when (event) {&#10;                is HomeEvent.LowStockAdded -&gt; {&#10;                    val destination = event.listName ?: context.getString(R.string.home_low_stock_destination_fallback)&#10;                    val message = context.getString(&#10;                        R.string.home_low_stock_add,&#10;                        event.quantity,&#10;                        destination&#10;                    )&#10;                    snackbarHost.showSnackbar(message)&#10;                }&#10;                is HomeEvent.ShowError -&gt; {&#10;                    snackbarHost.showSnackbar(event.message)&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    var pendingLowStock by remember { mutableStateOf&lt;LowStockItemUi?&gt;(null) }&#10;    var selectedListId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;    var pendingQuantity by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;&#10;    LaunchedEffect(pendingLowStock, uiState.listOptions) {&#10;        if (pendingLowStock != null &amp;&amp; selectedListId == null &amp;&amp; uiState.listOptions.isNotEmpty()) {&#10;            selectedListId = uiState.listOptions.first().id&#10;        }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            CenterAlignedTopAppBar(&#10;                title = { Text(stringResource(id = R.string.app_name), color = Color.White) },&#10;                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(&#10;                    containerColor = ColorPrimary,&#10;                    titleContentColor = Color.White,&#10;                    navigationIconContentColor = Color.White,&#10;                    actionIconContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snackbarHost) },&#10;        containerColor = MaterialTheme.colorScheme.background,&#10;    ) { padding -&gt;&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .verticalScroll(rememberScrollState())&#10;                .padding(padding)&#10;                .padding(horizontal = 16.dp, vertical = 24.dp),&#10;            verticalArrangement = Arrangement.spacedBy(20.dp)&#10;        ) {&#10;            ActiveListSection(&#10;                active = uiState.activeList,&#10;                onOpenList = onOpenList,&#10;                onCreateList = onCreateList,&#10;                purchasedCount = uiState.activePurchasedCount,&#10;                totalCount = uiState.activeTotalCount,&#10;                progress = uiState.activeProgress&#10;            )&#10;            QuickActionsSection(onCreateList, onNewProduct, onConfigureCategories)&#10;            LowStockSection(&#10;                items = uiState.lowStockItems,&#10;                onAdd = { item -&gt;&#10;                    pendingLowStock = item&#10;                    selectedListId = uiState.listOptions.firstOrNull()?.id&#10;                    pendingQuantity = item.suggestedQuantity.toString()&#10;                }&#10;            )&#10;        }&#10;    }&#10;&#10;    val dialogItem = pendingLowStock&#10;    if (dialogItem != null) {&#10;        LowStockAddDialog(&#10;            item = dialogItem,&#10;            listOptions = uiState.listOptions,&#10;            selectedListId = selectedListId,&#10;            quantityText = pendingQuantity,&#10;            isProcessing = uiState.isProcessingLowStock,&#10;            onListSelected = { selectedListId = it },&#10;            onQuantityChange = { newValue -&gt; pendingQuantity = newValue.filter { ch -&gt; ch.isDigit() } },&#10;            onDismiss = {&#10;                if (!uiState.isProcessingLowStock) {&#10;                    pendingLowStock = null&#10;                    selectedListId = null&#10;                    pendingQuantity = &quot;&quot;&#10;                }&#10;            },&#10;            onConfirm = {&#10;                val targetList = selectedListId&#10;                val quantity = pendingQuantity.toIntOrNull()&#10;                    ?: dialogItem.suggestedQuantity&#10;                if (targetList != null) {&#10;                    viewModel.addLowStockItemToList(dialogItem.pantryItemId, targetList, quantity)&#10;                    pendingLowStock = null&#10;                    selectedListId = null&#10;                    pendingQuantity = &quot;&quot;&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun ActiveListSection(&#10;    active: ShoppingListDto?,&#10;    onOpenList: (Long) -&gt; Unit,&#10;    onCreateList: () -&gt; Unit,&#10;    purchasedCount: Int,&#10;    totalCount: Int,&#10;    progress: Float&#10;) {&#10;    HomeSectionCard(containerColor = ButtonBlue) {&#10;        Text(&#10;            text = stringResource(id = R.string.home_active_list_title),&#10;            style = MaterialTheme.typography.titleMedium,&#10;            color = Color.White,&#10;            fontWeight = FontWeight.SemiBold&#10;        )&#10;        Spacer(Modifier.height(12.dp))&#10;&#10;        if (active != null) {&#10;            Text(&#10;                text = active.name,&#10;                style = MaterialTheme.typography.titleLarge,&#10;                fontWeight = FontWeight.Bold,&#10;                color = Color.White&#10;            )&#10;            Spacer(Modifier.height(12.dp))&#10;&#10;            if (totalCount &gt; 0) {&#10;                // Contenedor con esquinas redondeadas&#10;                Surface(&#10;                    color = MaterialTheme.colorScheme.surface,&#10;                    shape = RoundedCornerShape(12.dp),&#10;                    shadowElevation = 2.dp,&#10;                    modifier = Modifier.fillMaxWidth()&#10;                ) {&#10;                    Column(modifier = Modifier.padding(12.dp)) {&#10;                        Text(&quot;Progreso de la compra&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurface)&#10;                        Spacer(Modifier.height(6.dp))&#10;                        val animatedProgress by animateFloatAsState(&#10;                            targetValue = progress.coerceIn(0f, 1f),&#10;                            animationSpec = tween(durationMillis = 450, easing = FastOutSlowInEasing),&#10;                            label = &quot;homeActiveProgress&quot;&#10;                        )&#10;                        LinearProgressIndicator(&#10;                            progress = { animatedProgress },&#10;                            modifier = Modifier&#10;                                .fillMaxWidth()&#10;                                .height(8.dp),&#10;                            color = MaterialTheme.colorScheme.primary,&#10;                            trackColor = MaterialTheme.colorScheme.surfaceVariant&#10;                        )&#10;                        Spacer(Modifier.height(4.dp))&#10;                        val percent = (progress * 100).toInt()&#10;                        Text(&#10;                            text = &quot;$purchasedCount de $totalCount comprados ($percent%)&quot;,&#10;                            style = MaterialTheme.typography.labelSmall,&#10;                            color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                        )&#10;                    }&#10;                }&#10;                Spacer(Modifier.height(12.dp))&#10;            }&#10;&#10;            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                Button(&#10;                    onClick = { onOpenList(active.id) },&#10;                    colors = ButtonDefaults.buttonColors(containerColor = Color.White, contentColor = ButtonBlue)&#10;                ) {&#10;                    Text(text = stringResource(id = R.string.home_active_list_open_button))&#10;                }&#10;            }&#10;        } else {&#10;            Text(&#10;                text = stringResource(id = R.string.home_active_list_empty_title),&#10;                style = MaterialTheme.typography.titleMedium,&#10;                fontWeight = FontWeight.SemiBold,&#10;                color = Color.White&#10;            )&#10;            Spacer(Modifier.height(24.dp))&#10;            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {&#10;                OutlinedButton(&#10;                    onClick = onCreateList,&#10;                    colors = ButtonDefaults.outlinedButtonColors(contentColor = Color.White),&#10;                    border = BorderStroke(1.dp, Color.White.copy(alpha = 0.8f))&#10;                ) {&#10;                    Text(text = stringResource(id = R.string.home_create_list_button))&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun QuickActionsSection(&#10;    onCreateList: () -&gt; Unit,&#10;    onNewProduct: () -&gt; Unit,&#10;    onConfigureCategories: () -&gt; Unit&#10;) {&#10;    val actions = listOf(&#10;        QuickActionItem(&#10;            icon = Icons.Rounded.PlaylistAdd,&#10;            label = stringResource(id = R.string.home_quick_action_new_list_title),&#10;            onClick = onCreateList&#10;        ),&#10;        QuickActionItem(&#10;            icon = Icons.Rounded.AddShoppingCart,&#10;            label = stringResource(id = R.string.home_quick_action_new_product_title),&#10;            onClick = onNewProduct&#10;        ),&#10;        QuickActionItem(&#10;            icon = Icons.Rounded.Category,&#10;            label = stringResource(id = R.string.home_quick_action_categories_title),&#10;            onClick = onConfigureCategories&#10;        )&#10;    )&#10;&#10;    HomeSectionCard {&#10;        Text(&#10;            text = stringResource(id = R.string.home_quick_actions_title),&#10;            style = MaterialTheme.typography.titleMedium,&#10;            color = PrimaryTextBlue,&#10;            fontWeight = FontWeight.SemiBold&#10;        )&#10;        Spacer(Modifier.height(16.dp))&#10;        QuickActionsRow(actions = actions)&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun LowStockSection(&#10;    items: List&lt;LowStockItemUi&gt;,&#10;    onAdd: (LowStockItemUi) -&gt; Unit&#10;) {&#10;    HomeSectionCard {&#10;        Text(&#10;            text = stringResource(id = R.string.home_low_stock_title),&#10;            style = MaterialTheme.typography.titleMedium,&#10;            color = PrimaryTextBlue,&#10;            fontWeight = FontWeight.SemiBold&#10;        )&#10;        Spacer(Modifier.height(8.dp))&#10;        if (items.isEmpty()) {&#10;            Text(&#10;                text = stringResource(id = R.string.home_low_stock_empty),&#10;                style = MaterialTheme.typography.bodyMedium,&#10;                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;            )&#10;        } else {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                items.forEach { item -&gt;&#10;                    Row(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.SpaceBetween,&#10;                        verticalAlignment = Alignment.CenterVertically&#10;                    ) {&#10;                        Column(modifier = Modifier.weight(1f)) {&#10;                            val quantityDisplay = if ((item.currentQuantity % 1.0) == 0.0) {&#10;                                item.currentQuantity.toInt().toString()&#10;                            } else {&#10;                                String.format(Locale.getDefault(), &quot;%.1f&quot;, item.currentQuantity)&#10;                            }&#10;                            Text(&#10;                                text = item.name.ifBlank { stringResource(id = R.string.home_low_stock_unknown_product) },&#10;                                style = MaterialTheme.typography.bodyLarge,&#10;                                fontWeight = FontWeight.SemiBold&#10;                            )&#10;                            Text(&#10;                                text = &quot;$quantityDisplay ${item.unit} • mín. ${item.lowStockThreshold}&quot;,&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant&#10;                            )&#10;                        }&#10;                        IconButton(&#10;                            onClick = { onAdd(item) }&#10;                        ) {&#10;                            Icon(&#10;                                imageVector = Icons.Rounded.Add,&#10;                                contentDescription = stringResource(id = R.string.home_low_stock_add_button_content_desc),&#10;                                tint = ButtonBlue&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun HomeSectionCard(&#10;    modifier: Modifier = Modifier,&#10;    containerColor: Color = MaterialTheme.colorScheme.surface,&#10;    content: @Composable ColumnScope.() -&gt; Unit&#10;) {&#10;    Surface(&#10;        modifier = modifier.fillMaxWidth(),&#10;        shape = RoundedCornerShape(20.dp),&#10;        tonalElevation = 1.dp,&#10;        shadowElevation = 2.dp,&#10;        color = containerColor&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(20.dp),&#10;            content = content&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun QuickActionsRow(actions: List&lt;QuickActionItem&gt;) {&#10;    Row(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;    ) {&#10;        actions.forEach { action -&gt;&#10;            QuickActionCard(&#10;                modifier = Modifier.weight(1f),&#10;                action = action&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun QuickActionCard(&#10;    modifier: Modifier = Modifier,&#10;    action: QuickActionItem&#10;) {&#10;    Surface(&#10;        modifier = modifier.height(132.dp),&#10;        onClick = action.onClick,&#10;        shape = RoundedCornerShape(16.dp),&#10;        color = MaterialTheme.colorScheme.surface,&#10;        tonalElevation = 0.dp,&#10;        shadowElevation = 0.dp,&#10;        border = BorderStroke(1.dp, ColorPrimaryBorder)&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(16.dp),&#10;            verticalArrangement = Arrangement.SpaceBetween,&#10;            horizontalAlignment = Alignment.CenterHorizontally&#10;        ) {&#10;            Box(&#10;                modifier = Modifier&#10;                    .size(48.dp)&#10;                    .clip(RoundedCornerShape(24.dp))&#10;                    .background(ButtonBlue.copy(alpha = 0.15f)),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Icon(&#10;                    imageVector = action.icon,&#10;                    contentDescription = null,&#10;                    tint = ButtonBlue&#10;                )&#10;            }&#10;            Text(&#10;                text = action.label,&#10;                style = MaterialTheme.typography.bodySmall,&#10;                fontWeight = FontWeight.SemiBold,&#10;                textAlign = TextAlign.Center&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;private data class QuickActionItem(&#10;    val icon: androidx.compose.ui.graphics.vector.ImageVector,&#10;    val label: String,&#10;    val onClick: () -&gt; Unit&#10;)&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun LowStockAddDialog(&#10;    item: LowStockItemUi,&#10;    listOptions: List&lt;ShoppingListOption&gt;,&#10;    selectedListId: Long?,&#10;    quantityText: String,&#10;    isProcessing: Boolean,&#10;    onListSelected: (Long?) -&gt; Unit,&#10;    onQuantityChange: (String) -&gt; Unit,&#10;    onDismiss: () -&gt; Unit,&#10;    onConfirm: () -&gt; Unit&#10;) {&#10;    val hasLists = listOptions.isNotEmpty()&#10;    val isValidQuantity = quantityText.toIntOrNull()?.let { it &gt; 0 } == true&#10;    val confirmEnabled = hasLists &amp;&amp; selectedListId != null &amp;&amp; isValidQuantity &amp;&amp; !isProcessing&#10;    var expanded by remember { mutableStateOf(false) }&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!isProcessing) onDismiss() },&#10;        confirmButton = {&#10;            TextButton(onClick = { if (confirmEnabled) onConfirm() }, enabled = confirmEnabled) {&#10;                Text(text = stringResource(id = R.string.add))&#10;            }&#10;        },&#10;        dismissButton = {&#10;            TextButton(onClick = { if (!isProcessing) onDismiss() }) {&#10;                Text(text = stringResource(id = R.string.cancel))&#10;            }&#10;        },&#10;        title = { Text(text = stringResource(id = R.string.home_low_stock_dialog_title)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                val displayName = if (item.name.isNotBlank()) {&#10;                    item.name&#10;                } else {&#10;                    stringResource(id = R.string.home_low_stock_unknown_product)&#10;                }&#10;                Text(&#10;                    text = displayName,&#10;                    style = MaterialTheme.typography.bodyLarge,&#10;                    fontWeight = FontWeight.SemiBold&#10;                )&#10;                if (hasLists) {&#10;                    val selectedName = listOptions.firstOrNull { it.id == selectedListId }?.name.orEmpty()&#10;                    Box {&#10;                        OutlinedTextField(&#10;                            value = selectedName,&#10;                            onValueChange = {},&#10;                            readOnly = true,&#10;                            enabled = !isProcessing,&#10;                            label = { Text(stringResource(id = R.string.home_low_stock_select_list)) },&#10;                            trailingIcon = {&#10;                                Icon(&#10;                                    imageVector = Icons.Filled.ArrowDropDown,&#10;                                    contentDescription = null&#10;                                )&#10;                            },&#10;                            modifier = Modifier&#10;                                .fillMaxWidth()&#10;                                .clickable(enabled = !isProcessing) { expanded = true }&#10;                        )&#10;                        DropdownMenu(&#10;                            expanded = expanded,&#10;                            onDismissRequest = { expanded = false }&#10;                        ) {&#10;                            listOptions.forEach { option -&gt;&#10;                                DropdownMenuItem(&#10;                                    text = { Text(option.name) },&#10;                                    onClick = {&#10;                                        onListSelected(option.id)&#10;                                        expanded = false&#10;                                    }&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;                } else {&#10;                    Text(&#10;                        text = stringResource(id = R.string.home_low_stock_no_lists),&#10;                        style = MaterialTheme.typography.bodyMedium,&#10;                        color = MaterialTheme.colorScheme.error&#10;                    )&#10;                }&#10;                OutlinedTextField(&#10;                    value = quantityText,&#10;                    onValueChange = onQuantityChange,&#10;                    label = { Text(stringResource(id = R.string.home_low_stock_quantity_label)) },&#10;                    singleLine = true&#10;                )&#10;            }&#10;        }&#10;    )&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/screens/lists/ListDetailScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/screens/lists/ListDetailScreen.kt" />
              <option name="originalContent" value="package com.example.tuchanguito.ui.screens.lists&#10;&#10;import androidx.compose.animation.core.FastOutSlowInEasing&#10;import androidx.compose.animation.core.animateFloatAsState&#10;import androidx.compose.animation.core.tween&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Box&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.PaddingValues&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxSize&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.height&#10;import androidx.compose.foundation.layout.heightIn&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.layout.width&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.text.KeyboardOptions&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.Add&#10;import androidx.compose.material.icons.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.ArrowDropDown&#10;import androidx.compose.material.icons.filled.Delete&#10;import androidx.compose.material.icons.filled.Remove&#10;import androidx.compose.material.icons.filled.Share&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.AssistChip&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.Card&#10;import androidx.compose.material3.ButtonDefaults&#10;import androidx.compose.material3.CardDefaults&#10;import androidx.compose.material3.CenterAlignedTopAppBar&#10;import androidx.compose.material3.Checkbox&#10;import androidx.compose.material3.CircularProgressIndicator&#10;import androidx.compose.material3.Divider&#10;import androidx.compose.material3.DropdownMenu&#10;import androidx.compose.material3.DropdownMenuItem&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.IconButton&#10;import androidx.compose.material3.LinearProgressIndicator&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.RadioButton&#10;import androidx.compose.material3.Scaffold&#10;import androidx.compose.material3.SnackbarHost&#10;import androidx.compose.material3.SnackbarHostState&#10;import androidx.compose.material3.Surface&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextButton&#10;import androidx.compose.material3.TopAppBarDefaults&#10;import androidx.compose.material3.rememberSwipeToDismissBoxState&#10;import androidx.compose.material3.SwipeToDismissBox&#10;import androidx.compose.material3.SwipeToDismissBoxValue&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.collectAsState&#10;import androidx.compose.runtime.derivedStateOf&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.platform.LocalFocusManager&#10;import androidx.compose.ui.res.stringResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.text.input.KeyboardType&#10;import androidx.compose.ui.text.style.TextAlign&#10;import androidx.compose.ui.text.style.TextDecoration&#10;import androidx.compose.ui.text.style.TextOverflow&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import com.example.tuchanguito.MyApplication&#10;import com.example.tuchanguito.R&#10;import com.example.tuchanguito.data.model.Category&#10;import com.example.tuchanguito.data.model.Product&#10;import com.example.tuchanguito.data.network.model.ListItemDto&#10;import com.example.tuchanguito.data.network.model.ProductDto&#10;import com.example.tuchanguito.data.network.model.ShoppingListDto&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailEvent.ItemAdded&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailEvent.ListFinalized&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailEvent.ShowSnackbar&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailViewModel&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailViewModelFactory&#10;import com.example.tuchanguito.ui.screens.lists.ListFinalizeOptions&#10;import com.example.tuchanguito.ui.screens.lists.ShareUiState&#10;import com.example.tuchanguito.ui.theme.ColorAccent&#10;import com.example.tuchanguito.ui.theme.ColorPrimary&#10;import kotlinx.coroutines.flow.collectLatest&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.layout.wrapContentSize&#10;import androidx.compose.runtime.rememberCoroutineScope&#10;import kotlinx.coroutines.launch&#10;&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ListDetailScreen(listId: Long, onClose: () -&gt; Unit = {}) {&#10;    val context = LocalContext.current&#10;    val app = context.applicationContext as MyApplication&#10;    val viewModel: ListDetailViewModel = viewModel(&#10;        factory = ListDetailViewModelFactory(&#10;            listId = listId,&#10;            shoppingListsRepository = app.shoppingListsRepository,&#10;            productRepository = app.productRepository,&#10;            categoryRepository = app.categoryRepository,&#10;            pantryRepository = app.pantryRepository&#10;        )&#10;    )&#10;&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val shareState by viewModel.shareState.collectAsState()&#10;    val snackbarHost = remember { SnackbarHostState() }&#10;    val coroutineScope = rememberCoroutineScope()&#10;&#10;    // Determinar si la lista pertenece al usuario actual (owner != null)&#10;    val isOwner = uiState.list?.owner != null&#10;&#10;    var showAddProductDialog by remember { mutableStateOf(false) }&#10;    var showShareDialog by remember { mutableStateOf(false) }&#10;    var showFinalizeDialog by remember { mutableStateOf(false) }&#10;    var addDialogBusy by remember { mutableStateOf(false) }&#10;    var itemToDeleteId by remember { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    LaunchedEffect(Unit) {&#10;        viewModel.events.collectLatest { event -&gt;&#10;            when (event) {&#10;                is ShowSnackbar -&gt; {&#10;                    if (showAddProductDialog) addDialogBusy = false&#10;                    snackbarHost.showSnackbar(event.message)&#10;                }&#10;                ItemAdded -&gt; {&#10;                    addDialogBusy = false&#10;                    showAddProductDialog = false&#10;                }&#10;                ListFinalized -&gt; {&#10;                    showFinalizeDialog = false&#10;                    onClose()&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    val groupedItems = remember(uiState.items) {&#10;        uiState.items.groupBy { it.product.category?.name ?: &quot;Sin categoria&quot; }&#10;    }&#10;    val sortedCategories = remember(groupedItems) { groupedItems.keys.sortedBy { it.lowercase() } }&#10;    val totalCost by remember(uiState.items) {&#10;        derivedStateOf { uiState.items.sumOf { it.quantity * it.product.priceFromMetadata() } }&#10;    }&#10;    val categoryLookup = remember(uiState.products, uiState.categories) {&#10;        uiState.products.associate { product -&gt;&#10;            product.id to uiState.categories.firstOrNull { it.id == product.categoryId }?.name&#10;        }&#10;    }&#10;&#10;    val purchasedCount by remember(uiState.items) { derivedStateOf { uiState.items.count { it.purchased } } }&#10;    val totalCount by remember(uiState.items) { derivedStateOf { uiState.items.size } }&#10;    val progress by remember(purchasedCount, totalCount) {&#10;        derivedStateOf { if (totalCount == 0) 0f else purchasedCount.toFloat() / totalCount.toFloat() }&#10;    }&#10;    val animatedProgress by animateFloatAsState(&#10;        targetValue = progress.coerceIn(0f, 1f),&#10;        animationSpec = tween(durationMillis = 450, easing = FastOutSlowInEasing),&#10;        label = &quot;purchaseProgress&quot;&#10;    )&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            CenterAlignedTopAppBar(&#10;                title = {&#10;                    Text(&#10;                        uiState.list?.name ?: &quot;&quot;,&#10;                        maxLines = 1,&#10;                        overflow = TextOverflow.Ellipsis,&#10;                        fontWeight = FontWeight.Bold&#10;                    )&#10;                },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onClose) {&#10;                        Icon(Icons.Default.ArrowBack, contentDescription = stringResource(id = R.string.back))&#10;                    }&#10;                },&#10;                actions = {&#10;                    IconButton(onClick = { showShareDialog = true }) {&#10;                        Icon(Icons.Default.Share, contentDescription = stringResource(id = R.string.share_label))&#10;                    }&#10;                },&#10;                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(&#10;                    containerColor = ColorPrimary,&#10;                    titleContentColor = Color.White,&#10;                    navigationIconContentColor = Color.White,&#10;                    actionIconContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(hostState = snackbarHost) }&#10;    ) { padding -&gt;&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(padding)&#10;        ) {&#10;            if (totalCount &gt; 0) {&#10;                // Contenedor blanco con esquinas redondeadas y leve elevación&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 16.dp, vertical = 8.dp)&#10;                ) {&#10;                    Surface(&#10;                        color = Color.White,&#10;                        shape = RoundedCornerShape(12.dp),&#10;                        shadowElevation = 2.dp,&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    ) {&#10;                        Column(modifier = Modifier.padding(12.dp)) {&#10;                            Text(&quot;Progreso de la compra&quot;, style = MaterialTheme.typography.bodySmall)&#10;                            Spacer(Modifier.height(6.dp))&#10;                            LinearProgressIndicator(&#10;                                progress = { animatedProgress },&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(8.dp),&#10;                                color = ColorAccent,&#10;                                trackColor = Color.White&#10;                            )&#10;                            Spacer(Modifier.height(4.dp))&#10;                            val percent = (progress * 100).toInt()&#10;                            Text(&#10;                                text = &quot;$purchasedCount de $totalCount comprados ($percent%)&quot;,&#10;                                style = MaterialTheme.typography.labelSmall,&#10;                                color = Color.Gray,&#10;                                textAlign = TextAlign.Start&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (uiState.isLoading &amp;&amp; uiState.items.isEmpty()) {&#10;                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {&#10;                    CircularProgressIndicator()&#10;                }&#10;            } else {&#10;                if (uiState.items.isEmpty()) {&#10;                    Box(modifier = Modifier.fillMaxWidth().weight(1f), contentAlignment = Alignment.Center) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .wrapContentSize()&#10;                                .border(androidx.compose.foundation.BorderStroke(1.dp, Color.Black), shape = RoundedCornerShape(8.dp))&#10;                                .background(Color.Transparent, shape = RoundedCornerShape(8.dp))&#10;                                .padding(16.dp),&#10;                            contentAlignment = Alignment.Center&#10;                        ) {&#10;                            Text(&#10;                                text = stringResource(id = R.string.list_empty_message),&#10;                                style = MaterialTheme.typography.bodyLarge,&#10;                                textAlign = androidx.compose.ui.text.style.TextAlign.Center,&#10;                                modifier = Modifier.padding(4.dp)&#10;                            )&#10;                        }&#10;                    }&#10;                } else {&#10;                    LazyColumn(&#10;                        modifier = Modifier&#10;                            .weight(1f)&#10;                            .padding(horizontal = 16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(16.dp),&#10;                        contentPadding = PaddingValues(vertical = 16.dp)&#10;                    ) {&#10;                        item {&#10;                            CombinedCategoriesCard(&#10;                                sortedCategories = sortedCategories,&#10;                                groupedItems = groupedItems,&#10;                                onQuantityChange = { item, newQuantity -&gt;&#10;                                    viewModel.updateItemQuantity(&#10;                                        item.id,&#10;                                        item.product.id,&#10;                                        newQuantity,&#10;                                        item.unit ?: item.product.unitFromMetadata()&#10;                                    )&#10;                                },&#10;                                onRequestDelete = { item -&gt; itemToDeleteId = item.id },&#10;                                onToggleAcquired = { item, purchased -&gt; viewModel.toggleItem(item.id, purchased) }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;&#10;            Surface(shadowElevation = 8.dp, modifier = Modifier.fillMaxWidth()) {&#10;                Row(&#10;                    modifier = Modifier.padding(16.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Column(modifier = Modifier.weight(1f)) {&#10;                        Text(stringResource(R.string.total_cost), style = MaterialTheme.typography.bodySmall)&#10;                        Text(&quot;$%.2f&quot;.format(totalCost), style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)&#10;                    }&#10;&#10;                    Button(&#10;                        onClick = {&#10;                            if (isOwner) {&#10;                                showFinalizeDialog = true&#10;                            } else {&#10;                                // Mostrar mensaje claro cuando intenta finalizar una lista compartida&#10;                                coroutineScope.launch {&#10;                                    snackbarHost.showSnackbar(&#10;                                        context.getString(R.string.error_shared_list_finalize_not_allowed)&#10;                                    )&#10;                                }&#10;                            }&#10;                        },&#10;                        enabled = !uiState.isProcessing&#10;                    ) {&#10;                        Text(stringResource(id = R.string.finalize))&#10;                    }&#10;&#10;                    Spacer(Modifier.width(8.dp))&#10;&#10;                    Button(&#10;                        onClick = { showAddProductDialog = true },&#10;                        shape = CircleShape,&#10;                        contentPadding = PaddingValues(0.dp),&#10;                        modifier = Modifier.size(48.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = ColorAccent,&#10;                            contentColor = Color.White&#10;                        )&#10;                    ) {&#10;                        Icon(Icons.Default.Add, contentDescription = stringResource(id = R.string.add_product_to_list))&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    if (showAddProductDialog) {&#10;        AddItemDialog(&#10;            products = uiState.products,&#10;            categories = uiState.categories,&#10;            isSubmitting = addDialogBusy,&#10;            onDismiss = { if (!addDialogBusy) showAddProductDialog = false },&#10;            onAdd = { productId, name, price, unit, categoryName -&gt;&#10;                addDialogBusy = true&#10;                viewModel.addItem(productId, name, price, unit, categoryName)&#10;            },&#10;            categoryNameFor = { productId -&gt; categoryLookup[productId] }&#10;        )&#10;    }&#10;&#10;    if (showShareDialog) {&#10;        ShareListDialog(&#10;            state = shareState,&#10;            onDismiss = {&#10;                showShareDialog = false&#10;                viewModel.resetShareState()&#10;            },&#10;            onShare = { email -&gt; viewModel.shareList(email) }&#10;        )&#10;    }&#10;&#10;    if (showFinalizeDialog) {&#10;        FinalizeDialog(&#10;            listId = listId,&#10;            isProcessing = uiState.isProcessing,&#10;            availableLists = uiState.availableLists,&#10;            onDismiss = { if (!uiState.isProcessing) showFinalizeDialog = false },&#10;            onRequestLists = { viewModel.loadAvailableLists() },&#10;            onFinalize = { options -&gt; viewModel.finalizeList(options) }&#10;        )&#10;    }&#10;&#10;    if (itemToDeleteId != null) {&#10;        AlertDialog(&#10;            onDismissRequest = { itemToDeleteId = null },&#10;            title = { Text(stringResource(id = R.string.confirm_delete_title)) },&#10;            text = { Text(stringResource(id = R.string.confirm_delete_item_message)) },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    val id = itemToDeleteId ?: return@TextButton&#10;                    itemToDeleteId = null&#10;                    viewModel.deleteItem(id)&#10;                }) { Text(stringResource(id = R.string.delete_action)) }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { itemToDeleteId = null }) { Text(stringResource(id = R.string.cancel)) }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ListItemCard(&#10;    item: ListItemDto,&#10;    onQuantityChange: (Double) -&gt; Unit,&#10;    onRequestDelete: () -&gt; Unit,&#10;    onToggleAcquired: (Boolean) -&gt; Unit&#10;) {&#10;    val product = item.product&#10;    val formattedQuantity = remember(item.quantity) {&#10;        if (item.quantity % 1.0 == 0.0) item.quantity.toInt().toString() else &quot;%.2f&quot;.format(item.quantity)&#10;    }&#10;    val dismissState = rememberSwipeToDismissBoxState(&#10;        confirmValueChange = { target -&gt;&#10;            if (target == SwipeToDismissBoxValue.EndToStart) {&#10;                onRequestDelete()&#10;                false&#10;            } else {&#10;                false&#10;            }&#10;        }&#10;    )&#10;    SwipeToDismissBox(&#10;        state = dismissState,&#10;        enableDismissFromStartToEnd = false,&#10;        enableDismissFromEndToStart = true,&#10;        backgroundContent = {&#10;            val fgColor = MaterialTheme.colorScheme.onErrorContainer&#10;            Box(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .heightIn(min = 56.dp),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .heightIn(min = 56.dp),&#10;                    shape = RoundedCornerShape(12.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.errorContainer),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier.fillMaxSize(),&#10;                        contentAlignment = Alignment.Center&#10;                    ) {&#10;                        Icon(&#10;                            Icons.Default.Delete,&#10;                            contentDescription = null,&#10;                            tint = fgColor&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    ) {&#10;        Card(&#10;            modifier = Modifier.fillMaxWidth(),&#10;            shape = RoundedCornerShape(12.dp),&#10;            elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),&#10;            colors = CardDefaults.cardColors(&#10;                containerColor = MaterialTheme.colorScheme.surface,&#10;                contentColor = MaterialTheme.colorScheme.onSurface&#10;            )&#10;        ) {&#10;            Row(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(12.dp),&#10;                verticalAlignment = Alignment.CenterVertically,&#10;                horizontalArrangement = Arrangement.SpaceBetween&#10;            ) {&#10;                Checkbox(checked = item.purchased, onCheckedChange = onToggleAcquired)&#10;                Spacer(Modifier.width(8.dp))&#10;                Column(modifier = Modifier.weight(1f)) {&#10;                    Text(&#10;                        text = product.name,&#10;                        fontWeight = FontWeight.Bold,&#10;                        textDecoration = if (item.purchased) TextDecoration.LineThrough else TextDecoration.None&#10;                    )&#10;                    // Show only the price number (no &quot;c/u&quot;)&#10;                    Text(&#10;                        text = &quot;$%.2f&quot;.format(product.priceFromMetadata()),&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = Color.Gray&#10;                    )&#10;                }&#10;                Spacer(Modifier.width(8.dp))&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    IconButton(onClick = { if (item.quantity &gt; 1) onQuantityChange(item.quantity - 1) else onRequestDelete() }) {&#10;                        Icon(Icons.Default.Remove, contentDescription = &quot;Decrementar&quot;)&#10;                    }&#10;                    Text(formattedQuantity, fontWeight = FontWeight.Bold, fontSize = 18.sp)&#10;                    IconButton(onClick = { onQuantityChange(item.quantity + 1) }) {&#10;                        Icon(Icons.Default.Add, contentDescription = &quot;Incrementar&quot;)&#10;                    }&#10;                    IconButton(onClick = onRequestDelete) {&#10;                        Icon(Icons.Default.Delete, contentDescription = &quot;Eliminar&quot;, tint = MaterialTheme.colorScheme.error)&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun AddItemDialog(&#10;    products: List&lt;Product&gt;,&#10;    categories: List&lt;Category&gt;,&#10;    isSubmitting: Boolean,&#10;    onDismiss: () -&gt; Unit,&#10;    onAdd: (productId: Long?, name: String, price: Double?, unit: String?, categoryName: String) -&gt; Unit,&#10;    categoryNameFor: (Long) -&gt; String?&#10;) {&#10;    var name by remember { mutableStateOf(&quot;&quot;) }&#10;    var selectedId by remember { mutableStateOf&lt;Long?&gt;(null) }&#10;    var priceText by remember { mutableStateOf(&quot;&quot;) }&#10;    var unit by remember { mutableStateOf(&quot;&quot;) }&#10;    var categoryText by remember { mutableStateOf(&quot;&quot;) }&#10;&#10;    var productExpanded by remember { mutableStateOf(false) }&#10;    var categoryExpanded by remember { mutableStateOf(false) }&#10;&#10;    fun prefillFrom(product: Product) {&#10;        name = product.name&#10;        priceText = if (product.price &gt; 0) product.price.toString() else &quot;&quot;&#10;        unit = product.unit&#10;        categoryText = categoryNameFor(product.id) ?: &quot;&quot;&#10;        selectedId = product.id&#10;    }&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!isSubmitting) onDismiss() },&#10;        confirmButton = {&#10;            TextButton(&#10;                onClick = { onAdd(selectedId, name, priceText.toDoubleOrNull(), unit, categoryText) },&#10;                enabled = !isSubmitting &amp;&amp; name.trim().isNotBlank() &amp;&amp; categoryText.trim().isNotBlank()&#10;            ) { Text(stringResource(id = R.string.add)) }&#10;        },&#10;        dismissButton = { TextButton(onClick = { if (!isSubmitting) onDismiss() }) { Text(stringResource(id = R.string.cancel)) } },&#10;        title = { Text(stringResource(id = R.string.add_product_to_list)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                Box {&#10;                    OutlinedTextField(&#10;                        value = name,&#10;                        onValueChange = {&#10;                            name = it&#10;                            productExpanded = it.isNotBlank()&#10;                            selectedId = null&#10;                        },&#10;                        label = { Text(&quot;Producto&quot;) },&#10;                        trailingIcon = {&#10;                            Icon(&#10;                                Icons.Default.ArrowDropDown,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.clickable { productExpanded = !productExpanded }&#10;                            )&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                    val filteredProducts = products.filter { product -&gt;&#10;                        product.name.contains(name, ignoreCase = true) &amp;&amp; name.isNotBlank()&#10;                    }&#10;                    DropdownMenu(&#10;                        expanded = productExpanded &amp;&amp; filteredProducts.isNotEmpty(),&#10;                        onDismissRequest = { productExpanded = false }&#10;                    ) {&#10;                        filteredProducts.forEach { product -&gt;&#10;                            DropdownMenuItem(&#10;                                text = { Text(product.name) },&#10;                                onClick = {&#10;                                    prefillFrom(product)&#10;                                    productExpanded = false&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    OutlinedTextField(&#10;                        value = priceText,&#10;                        onValueChange = { value -&gt; priceText = value.filter { it.isDigit() || it == '.' } },&#10;                        label = { Text(stringResource(id = R.string.price_label)) },&#10;                        singleLine = true,&#10;                        keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),&#10;                        modifier = Modifier.weight(1f),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                    OutlinedTextField(&#10;                        value = unit,&#10;                        onValueChange = { unit = it },&#10;                        label = { Text(stringResource(id = R.string.unit_label)) },&#10;                        singleLine = true,&#10;                        modifier = Modifier.weight(1f),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                }&#10;&#10;                Box {&#10;                    OutlinedTextField(&#10;                        value = categoryText,&#10;                        onValueChange = {&#10;                            categoryText = it&#10;                            categoryExpanded = it.isNotBlank()&#10;                        },&#10;                        label = { Text(stringResource(id = R.string.category_label)) },&#10;                        trailingIcon = {&#10;                            Icon(&#10;                                Icons.Default.ArrowDropDown,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.clickable { categoryExpanded = !categoryExpanded }&#10;                            )&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                    val filteredCategories = categories.filter { option -&gt;&#10;                        option.name.contains(categoryText, ignoreCase = true) &amp;&amp; categoryText.isNotBlank()&#10;                    }&#10;                    DropdownMenu(&#10;                        expanded = categoryExpanded &amp;&amp; filteredCategories.isNotEmpty(),&#10;                        onDismissRequest = { categoryExpanded = false }&#10;                    ) {&#10;                        filteredCategories.forEach { category -&gt;&#10;                            DropdownMenuItem(&#10;                                text = { Text(category.name) },&#10;                                onClick = {&#10;                                    categoryText = category.name&#10;                                    categoryExpanded = false&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    )&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun ShareListDialog(&#10;    state: ShareUiState,&#10;    onDismiss: () -&gt; Unit,&#10;    onShare: (String) -&gt; Unit&#10;) {&#10;    var email by remember { mutableStateOf(&quot;&quot;) }&#10;    val isValid = remember(email) { email.contains(&quot;@&quot;) &amp;&amp; email.length &gt; 5 }&#10;    val focusManager = LocalFocusManager.current&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!state.isBusy) onDismiss() },&#10;        title = { Text(stringResource(id = R.string.share_dialog_title)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                if (state.isBusy) LinearProgressIndicator(Modifier.fillMaxWidth())&#10;                Text(stringResource(id = R.string.share_enter_email))&#10;                OutlinedTextField(&#10;                    value = email,&#10;                    onValueChange = { email = it },&#10;                    label = { Text(stringResource(id = R.string.email_label)) },&#10;                    singleLine = true,&#10;                    enabled = !state.isBusy,&#10;                    isError = !isValid &amp;&amp; email.isNotBlank(),&#10;                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Email)&#10;                )&#10;                state.message?.let {&#10;                    Text(&#10;                        it,&#10;                        color = if (state.isError) MaterialTheme.colorScheme.error else MaterialTheme.colorScheme.primary&#10;                    )&#10;                }&#10;            }&#10;        },&#10;        confirmButton = {&#10;            TextButton(onClick = { focusManager.clearFocus(); onShare(email.trim()) }, enabled = !state.isBusy &amp;&amp; isValid) {&#10;                Text(stringResource(id = R.string.share_button))&#10;            }&#10;        },&#10;        dismissButton = { TextButton(onClick = { if (!state.isBusy) onDismiss() }) { Text(stringResource(id = R.string.cancel)) } }&#10;    )&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun FinalizeDialog(&#10;    listId: Long,&#10;    isProcessing: Boolean,&#10;    availableLists: List&lt;ShoppingListDto&gt;,&#10;    onDismiss: () -&gt; Unit,&#10;    onRequestLists: () -&gt; Unit,&#10;    onFinalize: (ListFinalizeOptions) -&gt; Unit&#10;) {&#10;    var includePurchasedToPantry by remember { mutableStateOf(true) }&#10;    var moveNotPurchased by remember { mutableStateOf(true) }&#10;    var creatingNew by remember { mutableStateOf(false) }&#10;    var newListName by remember { mutableStateOf(&quot;&quot;) }&#10;    var selectedListId by remember { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    LaunchedEffect(Unit) { onRequestLists() }&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!isProcessing) onDismiss() },&#10;        confirmButton = {&#10;            TextButton(&#10;                enabled = !isProcessing,&#10;                onClick = {&#10;                    onFinalize(&#10;                        ListFinalizeOptions(&#10;                            includePurchasedToPantry = includePurchasedToPantry,&#10;                            moveNotPurchased = moveNotPurchased,&#10;                            targetListId = selectedListId,&#10;                            newListName = newListName.takeIf { creatingNew }&#10;                        )&#10;                    )&#10;                }&#10;            ) {&#10;                Text(if (isProcessing) stringResource(id = R.string.processing) else stringResource(id = R.string.finalize))&#10;            }&#10;        },&#10;        dismissButton = { TextButton(enabled = !isProcessing, onClick = onDismiss) { Text(stringResource(id = R.string.cancel)) } },&#10;        title = { Text(stringResource(id = R.string.finalize)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                Text(stringResource(id = R.string.finalize_question))&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    Checkbox(checked = includePurchasedToPantry, onCheckedChange = { includePurchasedToPantry = it })&#10;                    Spacer(Modifier.width(8.dp))&#10;                    Text(stringResource(id = R.string.add_purchased_to_pantry))&#10;                }&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    Checkbox(checked = moveNotPurchased, onCheckedChange = { moveNotPurchased = it })&#10;                    Spacer(Modifier.width(8.dp))&#10;                    Text(stringResource(id = R.string.move_not_purchased))&#10;                }&#10;                if (moveNotPurchased) {&#10;                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                        AssistChip(onClick = { creatingNew = false }, label = { Text(stringResource(id = R.string.select_list)) })&#10;                        AssistChip(onClick = { creatingNew = true }, label = { Text(stringResource(id = R.string.create_new)) })&#10;                    }&#10;                    if (creatingNew) {&#10;                        OutlinedTextField(&#10;                            value = newListName,&#10;                            onValueChange = { newListName = it },&#10;                            label = { Text(stringResource(id = R.string.new_list_name_label)) },&#10;                            singleLine = true,&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            enabled = !isProcessing&#10;                        )&#10;                    } else {&#10;                        Column {&#10;                            Text(stringResource(id = R.string.select_destination))&#10;                            val options = availableLists.filter { it.id != listId }&#10;                            if (options.isEmpty()) {&#10;                                Text(stringResource(id = R.string.no_lists_available))&#10;                            } else {&#10;                                options.forEach { list -&gt;&#10;                                    val selected = selectedListId == list.id&#10;                                    Row(&#10;                                        modifier = Modifier&#10;                                            .fillMaxWidth()&#10;                                            .clickable { selectedListId = list.id },&#10;                                        verticalAlignment = Alignment.CenterVertically&#10;                                    ) {&#10;                                        RadioButton(selected = selected, onClick = { selectedListId = list.id })&#10;                                        Text(list.name)&#10;                                    }&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    )&#10;}&#10;&#10;@Composable&#10;private fun CombinedCategoriesCard(&#10;    sortedCategories: List&lt;String&gt;,&#10;    groupedItems: Map&lt;String, List&lt;ListItemDto&gt;&gt;,&#10;    onQuantityChange: (ListItemDto, Double) -&gt; Unit,&#10;    onRequestDelete: (ListItemDto) -&gt; Unit,&#10;    onToggleAcquired: (ListItemDto, Boolean) -&gt; Unit&#10;) {&#10;    Card(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        shape = RoundedCornerShape(12.dp),&#10;        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),&#10;        colors = CardDefaults.cardColors(&#10;            containerColor = MaterialTheme.colorScheme.surface,&#10;            contentColor = MaterialTheme.colorScheme.onSurface&#10;        )&#10;    ) {&#10;        Column(modifier = Modifier.fillMaxWidth().padding(vertical = 8.dp)) {&#10;            sortedCategories.forEachIndexed { cIndex, categoryName -&gt;&#10;                val items = groupedItems[categoryName].orEmpty()&#10;                if (items.isEmpty()) return@forEachIndexed&#10;                // Título de categoría dentro de la tarjeta&#10;                Text(&#10;                    text = categoryName,&#10;                    style = MaterialTheme.typography.titleMedium,&#10;                    fontWeight = FontWeight.Bold,&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 12.dp, vertical = 8.dp)&#10;                )&#10;                // Filas de productos&#10;                items.forEachIndexed { index, item -&gt;&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(horizontal = 12.dp, vertical = 10.dp),&#10;                        verticalAlignment = Alignment.CenterVertically,&#10;                        horizontalArrangement = Arrangement.SpaceBetween&#10;                    ) {&#10;                        Checkbox(checked = item.purchased, onCheckedChange = { onToggleAcquired(item, it) })&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Column(modifier = Modifier.weight(1f)) {&#10;                            Text(&#10;                                text = item.product.name,&#10;                                fontWeight = FontWeight.Bold,&#10;                                textDecoration = if (item.purchased) TextDecoration.LineThrough else TextDecoration.None&#10;                            )&#10;                            Text(&#10;                                text = &quot;$%.2f&quot;.format(item.product.priceFromMetadata()),&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = Color.Gray&#10;                            )&#10;                        }&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Row(verticalAlignment = Alignment.CenterVertically) {&#10;                            IconButton(onClick = { if (item.quantity &gt; 1) onQuantityChange(item, item.quantity - 1) else onRequestDelete(item) }) {&#10;                                Icon(Icons.Default.Remove, contentDescription = &quot;Decrementar&quot;)&#10;                            }&#10;                            val formattedQuantity = if (item.quantity % 1.0 == 0.0) item.quantity.toInt().toString() else &quot;%.2f&quot;.format(item.quantity)&#10;                            Text(formattedQuantity, fontWeight = FontWeight.Bold, fontSize = 18.sp)&#10;                            IconButton(onClick = { onQuantityChange(item, item.quantity + 1) }) {&#10;                                Icon(Icons.Default.Add, contentDescription = &quot;Incrementar&quot;)&#10;                            }&#10;                            IconButton(onClick = { onRequestDelete(item) }) {&#10;                                Icon(Icons.Default.Delete, contentDescription = &quot;Eliminar&quot;, tint = MaterialTheme.colorScheme.error)&#10;                            }&#10;                        }&#10;                    }&#10;                    if (index &lt; items.lastIndex) {&#10;                        Divider(color = MaterialTheme.colorScheme.surfaceVariant)&#10;                    }&#10;                }&#10;                // Separador entre categorías dentro de la misma tarjeta&#10;                if (cIndex &lt; sortedCategories.lastIndex) {&#10;                    Divider(color = MaterialTheme.colorScheme.outlineVariant)&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;private fun ProductDto.priceFromMetadata(): Double {&#10;    val map = metadata as? Map&lt;*, *&gt; ?: return 0.0&#10;    val priceAny = map[&quot;price&quot;] ?: return 0.0&#10;    return (priceAny as? Number)?.toDouble() ?: priceAny.toString().toDoubleOrNull() ?: 0.0&#10;}&#10;&#10;private fun ProductDto.unitFromMetadata(): String {&#10;    val map = metadata as? Map&lt;*, *&gt; ?: return &quot;u&quot;&#10;    val unitAny = map[&quot;unit&quot;] ?: return &quot;u&quot;&#10;    return unitAny.toString().ifBlank { &quot;u&quot; }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.tuchanguito.ui.screens.lists&#10;&#10;import androidx.compose.animation.core.FastOutSlowInEasing&#10;import androidx.compose.animation.core.animateFloatAsState&#10;import androidx.compose.animation.core.tween&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Box&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.PaddingValues&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxSize&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.height&#10;import androidx.compose.foundation.layout.heightIn&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.layout.width&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.text.KeyboardOptions&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.Add&#10;import androidx.compose.material.icons.filled.ArrowBack&#10;import androidx.compose.material.icons.filled.ArrowDropDown&#10;import androidx.compose.material.icons.filled.Delete&#10;import androidx.compose.material.icons.filled.Remove&#10;import androidx.compose.material.icons.filled.Share&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.AssistChip&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.Card&#10;import androidx.compose.material3.ButtonDefaults&#10;import androidx.compose.material3.CardDefaults&#10;import androidx.compose.material3.CenterAlignedTopAppBar&#10;import androidx.compose.material3.Checkbox&#10;import androidx.compose.material3.CircularProgressIndicator&#10;import androidx.compose.material3.Divider&#10;import androidx.compose.material3.DropdownMenu&#10;import androidx.compose.material3.DropdownMenuItem&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.IconButton&#10;import androidx.compose.material3.LinearProgressIndicator&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.RadioButton&#10;import androidx.compose.material3.Scaffold&#10;import androidx.compose.material3.SnackbarHost&#10;import androidx.compose.material3.SnackbarHostState&#10;import androidx.compose.material3.Surface&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextButton&#10;import androidx.compose.material3.TopAppBarDefaults&#10;import androidx.compose.material3.rememberSwipeToDismissBoxState&#10;import androidx.compose.material3.SwipeToDismissBox&#10;import androidx.compose.material3.SwipeToDismissBoxValue&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.collectAsState&#10;import androidx.compose.runtime.derivedStateOf&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.platform.LocalFocusManager&#10;import androidx.compose.ui.res.stringResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.text.input.KeyboardType&#10;import androidx.compose.ui.text.style.TextAlign&#10;import androidx.compose.ui.text.style.TextDecoration&#10;import androidx.compose.ui.text.style.TextOverflow&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import com.example.tuchanguito.MyApplication&#10;import com.example.tuchanguito.R&#10;import com.example.tuchanguito.data.model.Category&#10;import com.example.tuchanguito.data.model.Product&#10;import com.example.tuchanguito.data.network.model.ListItemDto&#10;import com.example.tuchanguito.data.network.model.ProductDto&#10;import com.example.tuchanguito.data.network.model.ShoppingListDto&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailEvent.ItemAdded&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailEvent.ListFinalized&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailEvent.ShowSnackbar&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailViewModel&#10;import com.example.tuchanguito.ui.screens.lists.ListDetailViewModelFactory&#10;import com.example.tuchanguito.ui.screens.lists.ListFinalizeOptions&#10;import com.example.tuchanguito.ui.screens.lists.ShareUiState&#10;import com.example.tuchanguito.ui.theme.ColorAccent&#10;import com.example.tuchanguito.ui.theme.ColorPrimary&#10;import kotlinx.coroutines.flow.collectLatest&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.layout.wrapContentSize&#10;import androidx.compose.runtime.rememberCoroutineScope&#10;import kotlinx.coroutines.launch&#10;&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ListDetailScreen(listId: Long, onClose: () -&gt; Unit = {}) {&#10;    val context = LocalContext.current&#10;    val app = context.applicationContext as MyApplication&#10;    val viewModel: ListDetailViewModel = viewModel(&#10;        factory = ListDetailViewModelFactory(&#10;            listId = listId,&#10;            shoppingListsRepository = app.shoppingListsRepository,&#10;            productRepository = app.productRepository,&#10;            categoryRepository = app.categoryRepository,&#10;            pantryRepository = app.pantryRepository&#10;        )&#10;    )&#10;&#10;    val uiState by viewModel.uiState.collectAsState()&#10;    val shareState by viewModel.shareState.collectAsState()&#10;    val snackbarHost = remember { SnackbarHostState() }&#10;    val coroutineScope = rememberCoroutineScope()&#10;&#10;    // Determinar si la lista pertenece al usuario actual (owner != null)&#10;    val isOwner = uiState.list?.owner != null&#10;&#10;    var showAddProductDialog by remember { mutableStateOf(false) }&#10;    var showShareDialog by remember { mutableStateOf(false) }&#10;    var showFinalizeDialog by remember { mutableStateOf(false) }&#10;    var addDialogBusy by remember { mutableStateOf(false) }&#10;    var itemToDeleteId by remember { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    LaunchedEffect(Unit) {&#10;        viewModel.events.collectLatest { event -&gt;&#10;            when (event) {&#10;                is ShowSnackbar -&gt; {&#10;                    if (showAddProductDialog) addDialogBusy = false&#10;                    snackbarHost.showSnackbar(event.message)&#10;                }&#10;                ItemAdded -&gt; {&#10;                    addDialogBusy = false&#10;                    showAddProductDialog = false&#10;                }&#10;                ListFinalized -&gt; {&#10;                    showFinalizeDialog = false&#10;                    onClose()&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    val groupedItems = remember(uiState.items) {&#10;        uiState.items.groupBy { it.product.category?.name ?: &quot;Sin categoria&quot; }&#10;    }&#10;    val sortedCategories = remember(groupedItems) { groupedItems.keys.sortedBy { it.lowercase() } }&#10;    val totalCost by remember(uiState.items) {&#10;        derivedStateOf { uiState.items.sumOf { it.quantity * it.product.priceFromMetadata() } }&#10;    }&#10;    val categoryLookup = remember(uiState.products, uiState.categories) {&#10;        uiState.products.associate { product -&gt;&#10;            product.id to uiState.categories.firstOrNull { it.id == product.categoryId }?.name&#10;        }&#10;    }&#10;&#10;    val purchasedCount by remember(uiState.items) { derivedStateOf { uiState.items.count { it.purchased } } }&#10;    val totalCount by remember(uiState.items) { derivedStateOf { uiState.items.size } }&#10;    val progress by remember(purchasedCount, totalCount) {&#10;        derivedStateOf { if (totalCount == 0) 0f else purchasedCount.toFloat() / totalCount.toFloat() }&#10;    }&#10;    val animatedProgress by animateFloatAsState(&#10;        targetValue = progress.coerceIn(0f, 1f),&#10;        animationSpec = tween(durationMillis = 450, easing = FastOutSlowInEasing),&#10;        label = &quot;purchaseProgress&quot;&#10;    )&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            CenterAlignedTopAppBar(&#10;                title = {&#10;                    Text(&#10;                        uiState.list?.name ?: &quot;&quot;,&#10;                        maxLines = 1,&#10;                        overflow = TextOverflow.Ellipsis,&#10;                        fontWeight = FontWeight.Bold&#10;                    )&#10;                },&#10;                navigationIcon = {&#10;                    IconButton(onClick = onClose) {&#10;                        Icon(Icons.Default.ArrowBack, contentDescription = stringResource(id = R.string.back))&#10;                    }&#10;                },&#10;                actions = {&#10;                    IconButton(onClick = { showShareDialog = true }) {&#10;                        Icon(Icons.Default.Share, contentDescription = stringResource(id = R.string.share_label))&#10;                    }&#10;                },&#10;                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(&#10;                    containerColor = ColorPrimary,&#10;                    titleContentColor = Color.White,&#10;                    navigationIconContentColor = Color.White,&#10;                    actionIconContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(hostState = snackbarHost) }&#10;    ) { padding -&gt;&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxSize()&#10;                .padding(padding)&#10;        ) {&#10;            if (totalCount &gt; 0) {&#10;                // Contenedor con esquinas redondeadas y leve elevación&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 16.dp, vertical = 8.dp)&#10;                ) {&#10;                    Surface(&#10;                        color = MaterialTheme.colorScheme.surface,&#10;                        shape = RoundedCornerShape(12.dp),&#10;                        shadowElevation = 2.dp,&#10;                        modifier = Modifier.fillMaxWidth()&#10;                    ) {&#10;                        Column(modifier = Modifier.padding(12.dp)) {&#10;                            Text(&quot;Progreso de la compra&quot;, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurface)&#10;                            Spacer(Modifier.height(6.dp))&#10;                            LinearProgressIndicator(&#10;                                progress = { animatedProgress },&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(8.dp),&#10;                                color = MaterialTheme.colorScheme.primary,&#10;                                trackColor = MaterialTheme.colorScheme.surfaceVariant&#10;                            )&#10;                            Spacer(Modifier.height(4.dp))&#10;                            val percent = (progress * 100).toInt()&#10;                            Text(&#10;                                text = &quot;$purchasedCount de $totalCount comprados ($percent%)&quot;,&#10;                                style = MaterialTheme.typography.labelSmall,&#10;                                color = MaterialTheme.colorScheme.onSurfaceVariant,&#10;                                textAlign = TextAlign.Start&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (uiState.isLoading &amp;&amp; uiState.items.isEmpty()) {&#10;                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {&#10;                    CircularProgressIndicator()&#10;                }&#10;            } else {&#10;                if (uiState.items.isEmpty()) {&#10;                    Box(modifier = Modifier.fillMaxWidth().weight(1f), contentAlignment = Alignment.Center) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .wrapContentSize()&#10;                                .border(androidx.compose.foundation.BorderStroke(1.dp, Color.Black), shape = RoundedCornerShape(8.dp))&#10;                                .background(Color.Transparent, shape = RoundedCornerShape(8.dp))&#10;                                .padding(16.dp),&#10;                            contentAlignment = Alignment.Center&#10;                        ) {&#10;                            Text(&#10;                                text = stringResource(id = R.string.list_empty_message),&#10;                                style = MaterialTheme.typography.bodyLarge,&#10;                                textAlign = androidx.compose.ui.text.style.TextAlign.Center,&#10;                                modifier = Modifier.padding(4.dp)&#10;                            )&#10;                        }&#10;                    }&#10;                } else {&#10;                    LazyColumn(&#10;                        modifier = Modifier&#10;                            .weight(1f)&#10;                            .padding(horizontal = 16.dp),&#10;                        verticalArrangement = Arrangement.spacedBy(16.dp),&#10;                        contentPadding = PaddingValues(vertical = 16.dp)&#10;                    ) {&#10;                        item {&#10;                            CombinedCategoriesCard(&#10;                                sortedCategories = sortedCategories,&#10;                                groupedItems = groupedItems,&#10;                                onQuantityChange = { item, newQuantity -&gt;&#10;                                    viewModel.updateItemQuantity(&#10;                                        item.id,&#10;                                        item.product.id,&#10;                                        newQuantity,&#10;                                        item.unit ?: item.product.unitFromMetadata()&#10;                                    )&#10;                                },&#10;                                onRequestDelete = { item -&gt; itemToDeleteId = item.id },&#10;                                onToggleAcquired = { item, purchased -&gt; viewModel.toggleItem(item.id, purchased) }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;&#10;            Surface(shadowElevation = 8.dp, modifier = Modifier.fillMaxWidth()) {&#10;                Row(&#10;                    modifier = Modifier.padding(16.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Column(modifier = Modifier.weight(1f)) {&#10;                        Text(stringResource(R.string.total_cost), style = MaterialTheme.typography.bodySmall)&#10;                        Text(&quot;$%.2f&quot;.format(totalCost), style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)&#10;                    }&#10;&#10;                    Button(&#10;                        onClick = {&#10;                            if (isOwner) {&#10;                                showFinalizeDialog = true&#10;                            } else {&#10;                                // Mostrar mensaje claro cuando intenta finalizar una lista compartida&#10;                                coroutineScope.launch {&#10;                                    snackbarHost.showSnackbar(&#10;                                        context.getString(R.string.error_shared_list_finalize_not_allowed)&#10;                                    )&#10;                                }&#10;                            }&#10;                        },&#10;                        enabled = !uiState.isProcessing&#10;                    ) {&#10;                        Text(stringResource(id = R.string.finalize))&#10;                    }&#10;&#10;                    Spacer(Modifier.width(8.dp))&#10;&#10;                    Button(&#10;                        onClick = { showAddProductDialog = true },&#10;                        shape = CircleShape,&#10;                        contentPadding = PaddingValues(0.dp),&#10;                        modifier = Modifier.size(48.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = ColorAccent,&#10;                            contentColor = Color.White&#10;                        )&#10;                    ) {&#10;                        Icon(Icons.Default.Add, contentDescription = stringResource(id = R.string.add_product_to_list))&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    if (showAddProductDialog) {&#10;        AddItemDialog(&#10;            products = uiState.products,&#10;            categories = uiState.categories,&#10;            isSubmitting = addDialogBusy,&#10;            onDismiss = { if (!addDialogBusy) showAddProductDialog = false },&#10;            onAdd = { productId, name, price, unit, categoryName -&gt;&#10;                addDialogBusy = true&#10;                viewModel.addItem(productId, name, price, unit, categoryName)&#10;            },&#10;            categoryNameFor = { productId -&gt; categoryLookup[productId] }&#10;        )&#10;    }&#10;&#10;    if (showShareDialog) {&#10;        ShareListDialog(&#10;            state = shareState,&#10;            onDismiss = {&#10;                showShareDialog = false&#10;                viewModel.resetShareState()&#10;            },&#10;            onShare = { email -&gt; viewModel.shareList(email) }&#10;        )&#10;    }&#10;&#10;    if (showFinalizeDialog) {&#10;        FinalizeDialog(&#10;            listId = listId,&#10;            isProcessing = uiState.isProcessing,&#10;            availableLists = uiState.availableLists,&#10;            onDismiss = { if (!uiState.isProcessing) showFinalizeDialog = false },&#10;            onRequestLists = { viewModel.loadAvailableLists() },&#10;            onFinalize = { options -&gt; viewModel.finalizeList(options) }&#10;        )&#10;    }&#10;&#10;    if (itemToDeleteId != null) {&#10;        AlertDialog(&#10;            onDismissRequest = { itemToDeleteId = null },&#10;            title = { Text(stringResource(id = R.string.confirm_delete_title)) },&#10;            text = { Text(stringResource(id = R.string.confirm_delete_item_message)) },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    val id = itemToDeleteId ?: return@TextButton&#10;                    itemToDeleteId = null&#10;                    viewModel.deleteItem(id)&#10;                }) { Text(stringResource(id = R.string.delete_action)) }&#10;            },&#10;            dismissButton = {&#10;                TextButton(onClick = { itemToDeleteId = null }) { Text(stringResource(id = R.string.cancel)) }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ListItemCard(&#10;    item: ListItemDto,&#10;    onQuantityChange: (Double) -&gt; Unit,&#10;    onRequestDelete: () -&gt; Unit,&#10;    onToggleAcquired: (Boolean) -&gt; Unit&#10;) {&#10;    val product = item.product&#10;    val formattedQuantity = remember(item.quantity) {&#10;        if (item.quantity % 1.0 == 0.0) item.quantity.toInt().toString() else &quot;%.2f&quot;.format(item.quantity)&#10;    }&#10;    val dismissState = rememberSwipeToDismissBoxState(&#10;        confirmValueChange = { target -&gt;&#10;            if (target == SwipeToDismissBoxValue.EndToStart) {&#10;                onRequestDelete()&#10;                false&#10;            } else {&#10;                false&#10;            }&#10;        }&#10;    )&#10;    SwipeToDismissBox(&#10;        state = dismissState,&#10;        enableDismissFromStartToEnd = false,&#10;        enableDismissFromEndToStart = true,&#10;        backgroundContent = {&#10;            val fgColor = MaterialTheme.colorScheme.onErrorContainer&#10;            Box(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .heightIn(min = 56.dp),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .heightIn(min = 56.dp),&#10;                    shape = RoundedCornerShape(12.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.errorContainer),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier.fillMaxSize(),&#10;                        contentAlignment = Alignment.Center&#10;                    ) {&#10;                        Icon(&#10;                            Icons.Default.Delete,&#10;                            contentDescription = null,&#10;                            tint = fgColor&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    ) {&#10;        Card(&#10;            modifier = Modifier.fillMaxWidth(),&#10;            shape = RoundedCornerShape(12.dp),&#10;            elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),&#10;            colors = CardDefaults.cardColors(&#10;                containerColor = MaterialTheme.colorScheme.surface,&#10;                contentColor = MaterialTheme.colorScheme.onSurface&#10;            )&#10;        ) {&#10;            Row(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(12.dp),&#10;                verticalAlignment = Alignment.CenterVertically,&#10;                horizontalArrangement = Arrangement.SpaceBetween&#10;            ) {&#10;                Checkbox(checked = item.purchased, onCheckedChange = onToggleAcquired)&#10;                Spacer(Modifier.width(8.dp))&#10;                Column(modifier = Modifier.weight(1f)) {&#10;                    Text(&#10;                        text = product.name,&#10;                        fontWeight = FontWeight.Bold,&#10;                        textDecoration = if (item.purchased) TextDecoration.LineThrough else TextDecoration.None&#10;                    )&#10;                    // Show only the price number (no &quot;c/u&quot;)&#10;                    Text(&#10;                        text = &quot;$%.2f&quot;.format(product.priceFromMetadata()),&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = Color.Gray&#10;                    )&#10;                }&#10;                Spacer(Modifier.width(8.dp))&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    IconButton(onClick = { if (item.quantity &gt; 1) onQuantityChange(item.quantity - 1) else onRequestDelete() }) {&#10;                        Icon(Icons.Default.Remove, contentDescription = &quot;Decrementar&quot;)&#10;                    }&#10;                    Text(formattedQuantity, fontWeight = FontWeight.Bold, fontSize = 18.sp)&#10;                    IconButton(onClick = { onQuantityChange(item.quantity + 1) }) {&#10;                        Icon(Icons.Default.Add, contentDescription = &quot;Incrementar&quot;)&#10;                    }&#10;                    IconButton(onClick = onRequestDelete) {&#10;                        Icon(Icons.Default.Delete, contentDescription = &quot;Eliminar&quot;, tint = MaterialTheme.colorScheme.error)&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun AddItemDialog(&#10;    products: List&lt;Product&gt;,&#10;    categories: List&lt;Category&gt;,&#10;    isSubmitting: Boolean,&#10;    onDismiss: () -&gt; Unit,&#10;    onAdd: (productId: Long?, name: String, price: Double?, unit: String?, categoryName: String) -&gt; Unit,&#10;    categoryNameFor: (Long) -&gt; String?&#10;) {&#10;    var name by remember { mutableStateOf(&quot;&quot;) }&#10;    var selectedId by remember { mutableStateOf&lt;Long?&gt;(null) }&#10;    var priceText by remember { mutableStateOf(&quot;&quot;) }&#10;    var unit by remember { mutableStateOf(&quot;&quot;) }&#10;    var categoryText by remember { mutableStateOf(&quot;&quot;) }&#10;&#10;    var productExpanded by remember { mutableStateOf(false) }&#10;    var categoryExpanded by remember { mutableStateOf(false) }&#10;&#10;    fun prefillFrom(product: Product) {&#10;        name = product.name&#10;        priceText = if (product.price &gt; 0) product.price.toString() else &quot;&quot;&#10;        unit = product.unit&#10;        categoryText = categoryNameFor(product.id) ?: &quot;&quot;&#10;        selectedId = product.id&#10;    }&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!isSubmitting) onDismiss() },&#10;        confirmButton = {&#10;            TextButton(&#10;                onClick = { onAdd(selectedId, name, priceText.toDoubleOrNull(), unit, categoryText) },&#10;                enabled = !isSubmitting &amp;&amp; name.trim().isNotBlank() &amp;&amp; categoryText.trim().isNotBlank()&#10;            ) { Text(stringResource(id = R.string.add)) }&#10;        },&#10;        dismissButton = { TextButton(onClick = { if (!isSubmitting) onDismiss() }) { Text(stringResource(id = R.string.cancel)) } },&#10;        title = { Text(stringResource(id = R.string.add_product_to_list)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                Box {&#10;                    OutlinedTextField(&#10;                        value = name,&#10;                        onValueChange = {&#10;                            name = it&#10;                            productExpanded = it.isNotBlank()&#10;                            selectedId = null&#10;                        },&#10;                        label = { Text(&quot;Producto&quot;) },&#10;                        trailingIcon = {&#10;                            Icon(&#10;                                Icons.Default.ArrowDropDown,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.clickable { productExpanded = !productExpanded }&#10;                            )&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                    val filteredProducts = products.filter { product -&gt;&#10;                        product.name.contains(name, ignoreCase = true) &amp;&amp; name.isNotBlank()&#10;                    }&#10;                    DropdownMenu(&#10;                        expanded = productExpanded &amp;&amp; filteredProducts.isNotEmpty(),&#10;                        onDismissRequest = { productExpanded = false }&#10;                    ) {&#10;                        filteredProducts.forEach { product -&gt;&#10;                            DropdownMenuItem(&#10;                                text = { Text(product.name) },&#10;                                onClick = {&#10;                                    prefillFrom(product)&#10;                                    productExpanded = false&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    OutlinedTextField(&#10;                        value = priceText,&#10;                        onValueChange = { value -&gt; priceText = value.filter { it.isDigit() || it == '.' } },&#10;                        label = { Text(stringResource(id = R.string.price_label)) },&#10;                        singleLine = true,&#10;                        keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),&#10;                        modifier = Modifier.weight(1f),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                    OutlinedTextField(&#10;                        value = unit,&#10;                        onValueChange = { unit = it },&#10;                        label = { Text(stringResource(id = R.string.unit_label)) },&#10;                        singleLine = true,&#10;                        modifier = Modifier.weight(1f),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                }&#10;&#10;                Box {&#10;                    OutlinedTextField(&#10;                        value = categoryText,&#10;                        onValueChange = {&#10;                            categoryText = it&#10;                            categoryExpanded = it.isNotBlank()&#10;                        },&#10;                        label = { Text(stringResource(id = R.string.category_label)) },&#10;                        trailingIcon = {&#10;                            Icon(&#10;                                Icons.Default.ArrowDropDown,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.clickable { categoryExpanded = !categoryExpanded }&#10;                            )&#10;                        },&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        enabled = !isSubmitting&#10;                    )&#10;                    val filteredCategories = categories.filter { option -&gt;&#10;                        option.name.contains(categoryText, ignoreCase = true) &amp;&amp; categoryText.isNotBlank()&#10;                    }&#10;                    DropdownMenu(&#10;                        expanded = categoryExpanded &amp;&amp; filteredCategories.isNotEmpty(),&#10;                        onDismissRequest = { categoryExpanded = false }&#10;                    ) {&#10;                        filteredCategories.forEach { category -&gt;&#10;                            DropdownMenuItem(&#10;                                text = { Text(category.name) },&#10;                                onClick = {&#10;                                    categoryText = category.name&#10;                                    categoryExpanded = false&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    )&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun ShareListDialog(&#10;    state: ShareUiState,&#10;    onDismiss: () -&gt; Unit,&#10;    onShare: (String) -&gt; Unit&#10;) {&#10;    var email by remember { mutableStateOf(&quot;&quot;) }&#10;    val isValid = remember(email) { email.contains(&quot;@&quot;) &amp;&amp; email.length &gt; 5 }&#10;    val focusManager = LocalFocusManager.current&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!state.isBusy) onDismiss() },&#10;        title = { Text(stringResource(id = R.string.share_dialog_title)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                if (state.isBusy) LinearProgressIndicator(Modifier.fillMaxWidth())&#10;                Text(stringResource(id = R.string.share_enter_email))&#10;                OutlinedTextField(&#10;                    value = email,&#10;                    onValueChange = { email = it },&#10;                    label = { Text(stringResource(id = R.string.email_label)) },&#10;                    singleLine = true,&#10;                    enabled = !state.isBusy,&#10;                    isError = !isValid &amp;&amp; email.isNotBlank(),&#10;                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Email)&#10;                )&#10;                state.message?.let {&#10;                    Text(&#10;                        it,&#10;                        color = if (state.isError) MaterialTheme.colorScheme.error else MaterialTheme.colorScheme.primary&#10;                    )&#10;                }&#10;            }&#10;        },&#10;        confirmButton = {&#10;            TextButton(onClick = { focusManager.clearFocus(); onShare(email.trim()) }, enabled = !state.isBusy &amp;&amp; isValid) {&#10;                Text(stringResource(id = R.string.share_button))&#10;            }&#10;        },&#10;        dismissButton = { TextButton(onClick = { if (!state.isBusy) onDismiss() }) { Text(stringResource(id = R.string.cancel)) } }&#10;    )&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;private fun FinalizeDialog(&#10;    listId: Long,&#10;    isProcessing: Boolean,&#10;    availableLists: List&lt;ShoppingListDto&gt;,&#10;    onDismiss: () -&gt; Unit,&#10;    onRequestLists: () -&gt; Unit,&#10;    onFinalize: (ListFinalizeOptions) -&gt; Unit&#10;) {&#10;    var includePurchasedToPantry by remember { mutableStateOf(true) }&#10;    var moveNotPurchased by remember { mutableStateOf(true) }&#10;    var creatingNew by remember { mutableStateOf(false) }&#10;    var newListName by remember { mutableStateOf(&quot;&quot;) }&#10;    var selectedListId by remember { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    LaunchedEffect(Unit) { onRequestLists() }&#10;&#10;    AlertDialog(&#10;        onDismissRequest = { if (!isProcessing) onDismiss() },&#10;        confirmButton = {&#10;            TextButton(&#10;                enabled = !isProcessing,&#10;                onClick = {&#10;                    onFinalize(&#10;                        ListFinalizeOptions(&#10;                            includePurchasedToPantry = includePurchasedToPantry,&#10;                            moveNotPurchased = moveNotPurchased,&#10;                            targetListId = selectedListId,&#10;                            newListName = newListName.takeIf { creatingNew }&#10;                        )&#10;                    )&#10;                }&#10;            ) {&#10;                Text(if (isProcessing) stringResource(id = R.string.processing) else stringResource(id = R.string.finalize))&#10;            }&#10;        },&#10;        dismissButton = { TextButton(enabled = !isProcessing, onClick = onDismiss) { Text(stringResource(id = R.string.cancel)) } },&#10;        title = { Text(stringResource(id = R.string.finalize)) },&#10;        text = {&#10;            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {&#10;                Text(stringResource(id = R.string.finalize_question))&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    Checkbox(checked = includePurchasedToPantry, onCheckedChange = { includePurchasedToPantry = it })&#10;                    Spacer(Modifier.width(8.dp))&#10;                    Text(stringResource(id = R.string.add_purchased_to_pantry))&#10;                }&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    Checkbox(checked = moveNotPurchased, onCheckedChange = { moveNotPurchased = it })&#10;                    Spacer(Modifier.width(8.dp))&#10;                    Text(stringResource(id = R.string.move_not_purchased))&#10;                }&#10;                if (moveNotPurchased) {&#10;                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                        AssistChip(onClick = { creatingNew = false }, label = { Text(stringResource(id = R.string.select_list)) })&#10;                        AssistChip(onClick = { creatingNew = true }, label = { Text(stringResource(id = R.string.create_new)) })&#10;                    }&#10;                    if (creatingNew) {&#10;                        OutlinedTextField(&#10;                            value = newListName,&#10;                            onValueChange = { newListName = it },&#10;                            label = { Text(stringResource(id = R.string.new_list_name_label)) },&#10;                            singleLine = true,&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            enabled = !isProcessing&#10;                        )&#10;                    } else {&#10;                        Column {&#10;                            Text(stringResource(id = R.string.select_destination))&#10;                            val options = availableLists.filter { it.id != listId }&#10;                            if (options.isEmpty()) {&#10;                                Text(stringResource(id = R.string.no_lists_available))&#10;                            } else {&#10;                                options.forEach { list -&gt;&#10;                                    val selected = selectedListId == list.id&#10;                                    Row(&#10;                                        modifier = Modifier&#10;                                            .fillMaxWidth()&#10;                                            .clickable { selectedListId = list.id },&#10;                                        verticalAlignment = Alignment.CenterVertically&#10;                                    ) {&#10;                                        RadioButton(selected = selected, onClick = { selectedListId = list.id })&#10;                                        Text(list.name)&#10;                                    }&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    )&#10;}&#10;&#10;@Composable&#10;private fun CombinedCategoriesCard(&#10;    sortedCategories: List&lt;String&gt;,&#10;    groupedItems: Map&lt;String, List&lt;ListItemDto&gt;&gt;,&#10;    onQuantityChange: (ListItemDto, Double) -&gt; Unit,&#10;    onRequestDelete: (ListItemDto) -&gt; Unit,&#10;    onToggleAcquired: (ListItemDto, Boolean) -&gt; Unit&#10;) {&#10;    Card(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        shape = RoundedCornerShape(12.dp),&#10;        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),&#10;        colors = CardDefaults.cardColors(&#10;            containerColor = MaterialTheme.colorScheme.surface,&#10;            contentColor = MaterialTheme.colorScheme.onSurface&#10;        )&#10;    ) {&#10;        Column(modifier = Modifier.fillMaxWidth().padding(vertical = 8.dp)) {&#10;            sortedCategories.forEachIndexed { cIndex, categoryName -&gt;&#10;                val items = groupedItems[categoryName].orEmpty()&#10;                if (items.isEmpty()) return@forEachIndexed&#10;                // Título de categoría dentro de la tarjeta&#10;                Text(&#10;                    text = categoryName,&#10;                    style = MaterialTheme.typography.titleMedium,&#10;                    fontWeight = FontWeight.Bold,&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 12.dp, vertical = 8.dp)&#10;                )&#10;                // Filas de productos&#10;                items.forEachIndexed { index, item -&gt;&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(horizontal = 12.dp, vertical = 10.dp),&#10;                        verticalAlignment = Alignment.CenterVertically,&#10;                        horizontalArrangement = Arrangement.SpaceBetween&#10;                    ) {&#10;                        Checkbox(checked = item.purchased, onCheckedChange = { onToggleAcquired(item, it) })&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Column(modifier = Modifier.weight(1f)) {&#10;                            Text(&#10;                                text = item.product.name,&#10;                                fontWeight = FontWeight.Bold,&#10;                                textDecoration = if (item.purchased) TextDecoration.LineThrough else TextDecoration.None&#10;                            )&#10;                            Text(&#10;                                text = &quot;$%.2f&quot;.format(item.product.priceFromMetadata()),&#10;                                style = MaterialTheme.typography.bodySmall,&#10;                                color = Color.Gray&#10;                            )&#10;                        }&#10;                        Spacer(Modifier.width(8.dp))&#10;                        Row(verticalAlignment = Alignment.CenterVertically) {&#10;                            IconButton(onClick = { if (item.quantity &gt; 1) onQuantityChange(item, item.quantity - 1) else onRequestDelete(item) }) {&#10;                                Icon(Icons.Default.Remove, contentDescription = &quot;Decrementar&quot;)&#10;                            }&#10;                            val formattedQuantity = if (item.quantity % 1.0 == 0.0) item.quantity.toInt().toString() else &quot;%.2f&quot;.format(item.quantity)&#10;                            Text(formattedQuantity, fontWeight = FontWeight.Bold, fontSize = 18.sp)&#10;                            IconButton(onClick = { onQuantityChange(item, item.quantity + 1) }) {&#10;                                Icon(Icons.Default.Add, contentDescription = &quot;Incrementar&quot;)&#10;                            }&#10;                            IconButton(onClick = { onRequestDelete(item) }) {&#10;                                Icon(Icons.Default.Delete, contentDescription = &quot;Eliminar&quot;, tint = MaterialTheme.colorScheme.error)&#10;                            }&#10;                        }&#10;                    }&#10;                    if (index &lt; items.lastIndex) {&#10;                        Divider(color = MaterialTheme.colorScheme.surfaceVariant)&#10;                    }&#10;                }&#10;                // Separador entre categorías dentro de la misma tarjeta&#10;                if (cIndex &lt; sortedCategories.lastIndex) {&#10;                    Divider(color = MaterialTheme.colorScheme.outlineVariant)&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;private fun ProductDto.priceFromMetadata(): Double {&#10;    val map = metadata as? Map&lt;*, *&gt; ?: return 0.0&#10;    val priceAny = map[&quot;price&quot;] ?: return 0.0&#10;    return (priceAny as? Number)?.toDouble() ?: priceAny.toString().toDoubleOrNull() ?: 0.0&#10;}&#10;&#10;private fun ProductDto.unitFromMetadata(): String {&#10;    val map = metadata as? Map&lt;*, *&gt; ?: return &quot;u&quot;&#10;    val unitAny = map[&quot;unit&quot;] ?: return &quot;u&quot;&#10;    return unitAny.toString().ifBlank { &quot;u&quot; }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>