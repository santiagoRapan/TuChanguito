<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/navigation/IconsProbe.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/navigation/IconsProbe.kt" />
              <option name="originalContent" value="&#10;&#10;&#10;&#10;" />
              <option name="updatedContent" value="// Archivo de prueba temporal para verificar disponibilidad de íconos de Material.&#10;// Ya no se utiliza y se deja intencionalmente vacío para evitar imports innecesarios." />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/screens/products/ProductsScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/tuchanguito/ui/screens/products/ProductsScreen.kt" />
              <option name="originalContent" value="package com.example.tuchanguito.ui.screens.products&#10;&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Box&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.PaddingValues&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxSize&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.heightIn&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.layout.width&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.LazyRow&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.Add&#10;import androidx.compose.material.icons.filled.Delete&#10;import androidx.compose.material.icons.filled.Edit&#10;import androidx.compose.material.icons.filled.Search&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.Card&#10;import androidx.compose.material3.CardDefaults&#10;import androidx.compose.material3.CenterAlignedTopAppBar&#10;import androidx.compose.material3.DropdownMenuItem&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.ExposedDropdownMenuBox&#10;import androidx.compose.material3.ExposedDropdownMenuDefaults&#10;import androidx.compose.material3.FilterChip&#10;import androidx.compose.material3.HorizontalDivider&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.IconButton&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.Scaffold&#10;import androidx.compose.material3.SnackbarHost&#10;import androidx.compose.material3.SnackbarHostState&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextButton&#10;import androidx.compose.material3.TopAppBarDefaults&#10;import androidx.compose.material3.rememberSwipeToDismissBoxState&#10;import androidx.compose.material3.SwipeToDismissBox&#10;import androidx.compose.material3.SwipeToDismissBoxValue&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.collectAsState&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.rememberCoroutineScope&#10;import androidx.compose.runtime.saveable.rememberSaveable&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.res.stringResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import com.example.tuchanguito.MyApplication&#10;import com.example.tuchanguito.R&#10;import com.example.tuchanguito.data.network.model.CategoryDto&#10;import com.example.tuchanguito.data.network.model.ProductDto&#10;import com.example.tuchanguito.ui.theme.ColorPrimary&#10;import kotlinx.coroutines.launch&#10;import kotlinx.serialization.json.JsonElement&#10;import kotlinx.serialization.json.contentOrNull&#10;import kotlinx.serialization.json.doubleOrNull&#10;import kotlinx.serialization.json.jsonObject&#10;import kotlinx.serialization.json.jsonPrimitive&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ProductsScreen() {&#10;    val context = LocalContext.current&#10;    val app = context.applicationContext as MyApplication&#10;    val catalogRepository = remember { app.catalogRepository }&#10;    val scope = rememberCoroutineScope()&#10;&#10;    val snack = remember { SnackbarHostState() }&#10;    val productsTitle = stringResource(id = R.string.products_title)&#10;    val newProductDesc = stringResource(id = R.string.new_product)&#10;    val searchLabel = stringResource(id = R.string.search)&#10;    val allLabel = stringResource(id = R.string.all)&#10;    val noProductsLabel = stringResource(id = R.string.no_products)&#10;    val createErrorLabel = stringResource(id = R.string.create_error)&#10;    val deleteErrorLabel = stringResource(id = R.string.delete_error)&#10;    val editLabel = stringResource(id = R.string.edit_profile) // reuse edit label&#10;    val deleteLabel = stringResource(id = R.string.delete_error)&#10;&#10;    var query by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;    var selectedCategoryId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    var showCreate by rememberSaveable { mutableStateOf(false) }&#10;    var editingProductId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    var remoteCategories by remember { mutableStateOf(listOf&lt;CategoryDto&gt;()) }&#10;    var remoteProducts by remember { mutableStateOf(listOf&lt;ProductDto&gt;()) }&#10;&#10;    LaunchedEffect(Unit) {&#10;        val res = catalogRepository.syncCatalog()&#10;        if (res.isFailure) snack.showSnackbar(res.exceptionOrNull()?.message ?: createErrorLabel)&#10;    }&#10;&#10;    LaunchedEffect(query) {&#10;        runCatching { catalogRepository.categoriesForQuery(query) }&#10;            .onSuccess { cats -&gt;&#10;                remoteCategories = cats&#10;                if (selectedCategoryId != null &amp;&amp; cats.none { it.id == selectedCategoryId }) selectedCategoryId = null&#10;            }&#10;            .onFailure { snack.showSnackbar(it.message ?: &quot;Error cargando categorías&quot;) }&#10;    }&#10;&#10;    LaunchedEffect(query, selectedCategoryId) {&#10;        runCatching { catalogRepository.searchProducts(name = query, categoryId = selectedCategoryId) }&#10;            .onSuccess { list -&gt; remoteProducts = list }&#10;            .onFailure { snack.showSnackbar(it.message ?: &quot;Error cargando productos&quot;) }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            CenterAlignedTopAppBar(&#10;                title = { Text(productsTitle, color = Color.White) },&#10;                windowInsets = TopAppBarDefaults.windowInsets,&#10;                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(&#10;                    containerColor = ColorPrimary,&#10;                    titleContentColor = Color.White,&#10;                    navigationIconContentColor = Color.White,&#10;                    actionIconContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snack) },&#10;        floatingActionButton = {&#10;            Button(&#10;                onClick = { showCreate = true },&#10;                shape = CircleShape,&#10;                contentPadding = PaddingValues(0.dp),&#10;                modifier = Modifier.size(48.dp)&#10;            ) {&#10;                Icon(Icons.Default.Add, contentDescription = newProductDesc)&#10;            }&#10;        }&#10;    ) { padding -&gt;&#10;        Column(&#10;            Modifier&#10;                .fillMaxSize()&#10;                .padding(padding)&#10;                .padding(16.dp),&#10;            verticalArrangement = Arrangement.spacedBy(12.dp)&#10;        ) {&#10;            OutlinedTextField(&#10;                value = query,&#10;                onValueChange = { query = it },&#10;                modifier = Modifier.fillMaxWidth(),&#10;                label = { Text(searchLabel) },&#10;                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },&#10;                singleLine = true&#10;            )&#10;&#10;            LazyRow(horizontalArrangement = Arrangement.spacedBy(8.dp), modifier = Modifier.fillMaxWidth()) {&#10;                item {&#10;                    FilterChip(&#10;                        selected = selectedCategoryId == null,&#10;                        onClick = { selectedCategoryId = null },&#10;                        label = { Text(allLabel) }&#10;                    )&#10;                }&#10;                items(remoteCategories.size) { index -&gt;&#10;                    val cat = remoteCategories[index]&#10;                    FilterChip(&#10;                        selected = selectedCategoryId == cat.id,&#10;                        onClick = { selectedCategoryId = cat.id },&#10;                        label = { Text(cat.name) }&#10;                    )&#10;                }&#10;            }&#10;&#10;            HorizontalDivider()&#10;&#10;            LazyColumn(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .weight(1f),&#10;                verticalArrangement = Arrangement.spacedBy(8.dp),&#10;                contentPadding = PaddingValues(bottom = 88.dp)&#10;            ) {&#10;                if (remoteProducts.isEmpty()) {&#10;                    item { Text(noProductsLabel, style = MaterialTheme.typography.bodyMedium) }&#10;                } else {&#10;                    items(remoteProducts.size, key = { idx -&gt; remoteProducts[idx].id ?: idx.toLong() }) { i -&gt;&#10;                        val p = remoteProducts[i]&#10;                        val dismissState = rememberSwipeToDismissBoxState(&#10;                            confirmValueChange = { target -&gt;&#10;                                if (target == SwipeToDismissBoxValue.EndToStart) {&#10;                                    scope.launch {&#10;                                        val id = p.id ?: return@launch&#10;                                        val res = runCatching { catalogRepository.deleteProduct(id) }&#10;                                        if (res.isFailure) {&#10;                                            snack.showSnackbar(res.exceptionOrNull()?.message ?: deleteErrorLabel)&#10;                                        } else {&#10;                                            remoteProducts = remoteProducts.filterNot { it.id == id }&#10;                                        }&#10;                                    }&#10;                                    true&#10;                                } else {&#10;                                    false&#10;                                }&#10;                            }&#10;                        )&#10;                        SwipeToDismissBox(&#10;                            state = dismissState,&#10;                            enableDismissFromStartToEnd = false,&#10;                            enableDismissFromEndToStart = true,&#10;                            backgroundContent = {&#10;                                val fgColor = MaterialTheme.colorScheme.onErrorContainer&#10;                                Box(&#10;                                    modifier = Modifier&#10;                                        .fillMaxWidth()&#10;                                        .heightIn(min = 56.dp)&#10;                                        .background(MaterialTheme.colorScheme.errorContainer)&#10;                                        .padding(vertical = 0.dp),&#10;                                    contentAlignment = Alignment.CenterEnd&#10;                                ) {&#10;                                    Row(&#10;                                        Modifier&#10;                                            .fillMaxWidth()&#10;                                            .padding(horizontal = 16.dp),&#10;                                        horizontalArrangement = Arrangement.End&#10;                                    ) {&#10;                                        Icon(&#10;                                            Icons.Filled.Delete,&#10;                                            contentDescription = null,&#10;                                            tint = fgColor&#10;                                        )&#10;                                    }&#10;                                }&#10;                            }&#10;                        ) {&#10;                            ProductCard(&#10;                                product = p,&#10;                                editLabel = editLabel,&#10;                                deleteLabel = deleteLabel,&#10;                                onEdit = { editingProductId = p.id },&#10;                                onDelete = {&#10;                                    scope.launch {&#10;                                        val id = p.id ?: return@launch&#10;                                        val res = runCatching { catalogRepository.deleteProduct(id) }&#10;                                        if (res.isFailure) {&#10;                                            snack.showSnackbar(res.exceptionOrNull()?.message ?: deleteErrorLabel)&#10;                                        } else {&#10;                                            remoteProducts = remoteProducts.filterNot { it.id == id }&#10;                                        }&#10;                                    }&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    if (showCreate) {&#10;        var name by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var priceText by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var unit by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var categoryId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;        var categoryInput by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var busy by remember { mutableStateOf(false) }&#10;        val valid = name.isNotBlank() &amp;&amp; (priceText.toDoubleOrNull() != null) &amp;&amp; unit.isNotBlank() &amp;&amp; (categoryId != null || categoryInput.isNotBlank())&#10;&#10;        AlertDialog(&#10;            onDismissRequest = { if (!busy) showCreate = false },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    scope.launch {&#10;                        busy = true&#10;                        try {&#10;                            val finalCategoryId = categoryId ?: catalogRepository.createOrFindCategoryByName(categoryInput)&#10;                            catalogRepository.createProduct(name.trim(), priceText.toDouble(), unit.trim(), finalCategoryId)&#10;                            showCreate = false&#10;                            remoteProducts = catalogRepository.searchProducts(query, selectedCategoryId)&#10;                            remoteCategories = catalogRepository.categoriesForQuery(query)&#10;                        } catch (t: Throwable) {&#10;                            snack.showSnackbar(t.message ?: createErrorLabel)&#10;                        } finally { busy = false }&#10;                    }&#10;                }, enabled = valid &amp;&amp; !busy) { Text(stringResource(id = R.string.create)) }&#10;            },&#10;            dismissButton = { TextButton(onClick = { if (!busy) showCreate = false }) { Text(stringResource(id = R.string.cancel)) } },&#10;            title = { Text(stringResource(id = R.string.new_product)) },&#10;            text = {&#10;                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    OutlinedTextField(value = name, onValueChange = { name = it }, label = { Text(stringResource(id = R.string.name_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = priceText, onValueChange = { priceText = it }, label = { Text(stringResource(id = R.string.price_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = unit, onValueChange = { unit = it }, label = { Text(stringResource(id = R.string.unit_label)) }, singleLine = true)&#10;                    var expanded by remember { mutableStateOf(false) }&#10;                    ExposedDropdownMenuBox(expanded = expanded, onExpandedChange = { expanded = it }) {&#10;                        OutlinedTextField(&#10;                            value = if (categoryId != null) remoteCategories.firstOrNull { it.id == categoryId }?.name ?: categoryInput else categoryInput,&#10;                            onValueChange = { input -&gt; categoryInput = input; categoryId = null },&#10;                            label = { Text(stringResource(id = R.string.category_label)) },&#10;                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded) },&#10;                            modifier = Modifier.menuAnchor().fillMaxWidth()&#10;                        )&#10;                        ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {&#10;                            remoteCategories.forEach { c -&gt;&#10;                                DropdownMenuItem(text = { Text(c.name) }, onClick = { categoryId = c.id; categoryInput = &quot;&quot;; expanded = false })&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        )&#10;    }&#10;&#10;    remoteProducts.firstOrNull { it.id == editingProductId }?.let { prod -&gt;&#10;        var name by rememberSaveable { mutableStateOf(prod.name) }&#10;        var priceText by rememberSaveable {&#10;            val price = prod.metadata.doubleValue(&quot;price&quot;)&#10;            mutableStateOf(price.toString())&#10;        }&#10;        var unit by rememberSaveable { mutableStateOf(prod.metadata.stringValue(&quot;unit&quot;)) }&#10;        var categoryId by rememberSaveable { mutableStateOf&lt;Long?&gt;(prod.category?.id) }&#10;        var categoryInput by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var busy by remember { mutableStateOf(false) }&#10;        val valid = name.isNotBlank() &amp;&amp; (priceText.toDoubleOrNull() != null) &amp;&amp; (categoryId != null || categoryInput.isNotBlank())&#10;&#10;        AlertDialog(&#10;            onDismissRequest = { if (!busy) editingProductId = null },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    scope.launch {&#10;                        busy = true&#10;                        try {&#10;                            val finalCategoryId = categoryId ?: catalogRepository.createOrFindCategoryByName(categoryInput)&#10;                            catalogRepository.updateProduct(prod.id, name.trim(), priceText.toDouble(), unit.trim(), finalCategoryId)&#10;                            editingProductId = null&#10;                            remoteProducts = catalogRepository.searchProducts(query, selectedCategoryId)&#10;                            remoteCategories = catalogRepository.categoriesForQuery(query)&#10;                        } catch (t: Throwable) {&#10;                            snack.showSnackbar(t.message ?: createErrorLabel)&#10;                        } finally { busy = false }&#10;                    }&#10;                }, enabled = valid &amp;&amp; !busy) { Text(stringResource(id = R.string.save_changes)) }&#10;            },&#10;            dismissButton = { TextButton(onClick = { if (!busy) editingProductId = null }) { Text(stringResource(id = R.string.cancel)) } },&#10;            title = { Text(stringResource(id = R.string.new_product)) },&#10;            text = {&#10;                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    OutlinedTextField(value = name, onValueChange = { name = it }, label = { Text(stringResource(id = R.string.name_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = priceText, onValueChange = { priceText = it }, label = { Text(stringResource(id = R.string.price_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = unit, onValueChange = { unit = it }, label = { Text(stringResource(id = R.string.unit_label)) }, singleLine = true)&#10;                    var expanded by remember { mutableStateOf(false) }&#10;                    ExposedDropdownMenuBox(expanded = expanded, onExpandedChange = { expanded = it }) {&#10;                        OutlinedTextField(&#10;                            value = if (categoryId != null) remoteCategories.firstOrNull { it.id == categoryId }?.name ?: categoryInput else categoryInput,&#10;                            onValueChange = { input -&gt; categoryInput = input; categoryId = null },&#10;                            label = { Text(stringResource(id = R.string.category_label)) },&#10;                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded) },&#10;                            modifier = Modifier.menuAnchor().fillMaxWidth()&#10;                        )&#10;                        ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {&#10;                            remoteCategories.forEach { c -&gt;&#10;                                DropdownMenuItem(text = { Text(c.name) }, onClick = { categoryId = c.id; categoryInput = &quot;&quot;; expanded = false })&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun ProductCard(&#10;    product: ProductDto,&#10;    editLabel: String,&#10;    deleteLabel: String,&#10;    onEdit: () -&gt; Unit,&#10;    onDelete: () -&gt; Unit&#10;) {&#10;    val priceVal = product.metadata.doubleValue(&quot;price&quot;)&#10;    val priceStr = &quot;%.2f&quot;.format(priceVal)&#10;&#10;    Card(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        shape = RoundedCornerShape(12.dp),&#10;        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;    ) {&#10;        Row(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(12.dp),&#10;            verticalAlignment = Alignment.CenterVertically,&#10;            horizontalArrangement = Arrangement.SpaceBetween&#10;        ) {&#10;            Column(modifier = Modifier.weight(1f)) {&#10;                Text(&#10;                    text = product.name,&#10;                    fontWeight = FontWeight.Bold&#10;                )&#10;                Text(&#10;                    text = &quot;${&quot;$&quot;}${priceStr} c/u&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = Color.Gray&#10;                )&#10;            }&#10;            Spacer(Modifier.width(8.dp))&#10;            Row(verticalAlignment = Alignment.CenterVertically) {&#10;                IconButton(onClick = onEdit) {&#10;                    Icon(&#10;                        imageVector = Icons.Filled.Edit,&#10;                        contentDescription = editLabel,&#10;                        tint = MaterialTheme.colorScheme.primary&#10;                    )&#10;                }&#10;                IconButton(onClick = onDelete) {&#10;                    Icon(&#10;                        imageVector = Icons.Filled.Delete,&#10;                        contentDescription = deleteLabel,&#10;                        tint = MaterialTheme.colorScheme.error&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;private fun JsonElement?.doubleValue(key: String, default: Double = 0.0): Double =&#10;    this?.jsonObject?.get(key)?.jsonPrimitive?.doubleOrNull ?: default&#10;&#10;private fun JsonElement?.stringValue(key: String): String =&#10;    this?.jsonObject?.get(key)?.jsonPrimitive?.contentOrNull.orEmpty()&#10;" />
              <option name="updatedContent" value="package com.example.tuchanguito.ui.screens.products&#10;&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Box&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.PaddingValues&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxSize&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.heightIn&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.layout.width&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.LazyRow&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.Add&#10;import androidx.compose.material.icons.filled.Delete&#10;import androidx.compose.material.icons.filled.Edit&#10;import androidx.compose.material.icons.filled.Search&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.Card&#10;import androidx.compose.material3.CardDefaults&#10;import androidx.compose.material3.CenterAlignedTopAppBar&#10;import androidx.compose.material3.DropdownMenuItem&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.ExposedDropdownMenuBox&#10;import androidx.compose.material3.ExposedDropdownMenuDefaults&#10;import androidx.compose.material3.FilterChip&#10;import androidx.compose.material3.HorizontalDivider&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.IconButton&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.Scaffold&#10;import androidx.compose.material3.SnackbarHost&#10;import androidx.compose.material3.SnackbarHostState&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextButton&#10;import androidx.compose.material3.TopAppBarDefaults&#10;import androidx.compose.material3.rememberSwipeToDismissBoxState&#10;import androidx.compose.material3.SwipeToDismissBox&#10;import androidx.compose.material3.SwipeToDismissBoxValue&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.collectAsState&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.rememberCoroutineScope&#10;import androidx.compose.runtime.saveable.rememberSaveable&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.res.stringResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import com.example.tuchanguito.MyApplication&#10;import com.example.tuchanguito.R&#10;import com.example.tuchanguito.data.network.model.CategoryDto&#10;import com.example.tuchanguito.data.network.model.ProductDto&#10;import com.example.tuchanguito.ui.theme.ColorPrimary&#10;import kotlinx.coroutines.launch&#10;import kotlinx.serialization.json.JsonElement&#10;import kotlinx.serialization.json.contentOrNull&#10;import kotlinx.serialization.json.doubleOrNull&#10;import kotlinx.serialization.json.jsonObject&#10;import kotlinx.serialization.json.jsonPrimitive&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun ProductsScreen() {&#10;    val context = LocalContext.current&#10;    val app = context.applicationContext as MyApplication&#10;    val catalogRepository = remember { app.catalogRepository }&#10;    val scope = rememberCoroutineScope()&#10;&#10;    val snack = remember { SnackbarHostState() }&#10;    val productsTitle = stringResource(id = R.string.products_title)&#10;    val newProductDesc = stringResource(id = R.string.new_product)&#10;    val searchLabel = stringResource(id = R.string.search)&#10;    val allLabel = stringResource(id = R.string.all)&#10;    val noProductsLabel = stringResource(id = R.string.no_products)&#10;    val createErrorLabel = stringResource(id = R.string.create_error)&#10;    val deleteErrorLabel = stringResource(id = R.string.delete_error)&#10;    val editLabel = stringResource(id = R.string.edit_profile) // reuse edit label&#10;    val deleteLabel = stringResource(id = R.string.delete_error)&#10;&#10;    var query by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;    var selectedCategoryId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    var showCreate by rememberSaveable { mutableStateOf(false) }&#10;    var editingProductId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;&#10;    var remoteCategories by remember { mutableStateOf(listOf&lt;CategoryDto&gt;()) }&#10;    var remoteProducts by remember { mutableStateOf(listOf&lt;ProductDto&gt;()) }&#10;&#10;    LaunchedEffect(Unit) {&#10;        val res = catalogRepository.syncCatalog()&#10;        if (res.isFailure) snack.showSnackbar(res.exceptionOrNull()?.message ?: createErrorLabel)&#10;    }&#10;&#10;    LaunchedEffect(query) {&#10;        runCatching { catalogRepository.categoriesForQuery(query) }&#10;            .onSuccess { cats -&gt;&#10;                remoteCategories = cats&#10;                if (selectedCategoryId != null &amp;&amp; cats.none { it.id == selectedCategoryId }) selectedCategoryId = null&#10;            }&#10;            .onFailure { snack.showSnackbar(it.message ?: &quot;Error cargando categorías&quot;) }&#10;    }&#10;&#10;    LaunchedEffect(query, selectedCategoryId) {&#10;        runCatching { catalogRepository.searchProducts(name = query, categoryId = selectedCategoryId) }&#10;            .onSuccess { list -&gt; remoteProducts = list }&#10;            .onFailure { snack.showSnackbar(it.message ?: &quot;Error cargando productos&quot;) }&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            CenterAlignedTopAppBar(&#10;                title = { Text(productsTitle, color = Color.White) },&#10;                windowInsets = TopAppBarDefaults.windowInsets,&#10;                colors = TopAppBarDefaults.centerAlignedTopAppBarColors(&#10;                    containerColor = ColorPrimary,&#10;                    titleContentColor = Color.White,&#10;                    navigationIconContentColor = Color.White,&#10;                    actionIconContentColor = Color.White&#10;                )&#10;            )&#10;        },&#10;        snackbarHost = { SnackbarHost(snack) },&#10;        floatingActionButton = {&#10;            Button(&#10;                onClick = { showCreate = true },&#10;                shape = CircleShape,&#10;                contentPadding = androidx.compose.foundation.layout.PaddingValues(0.dp),&#10;                modifier = Modifier.size(48.dp)&#10;            ) {&#10;                Icon(Icons.Default.Add, contentDescription = newProductDesc)&#10;            }&#10;        },&#10;        contentWindowInsets = androidx.compose.foundation.layout.WindowInsets.systemBars&#10;    ) { padding -&gt;&#10;        Column(&#10;            Modifier&#10;                .fillMaxSize()&#10;                .padding(padding)&#10;                .padding(16.dp),&#10;            verticalArrangement = Arrangement.spacedBy(12.dp)&#10;        ) {&#10;            OutlinedTextField(&#10;                value = query,&#10;                onValueChange = { query = it },&#10;                modifier = Modifier.fillMaxWidth(),&#10;                label = { Text(searchLabel) },&#10;                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },&#10;                singleLine = true&#10;            )&#10;&#10;            LazyRow(horizontalArrangement = Arrangement.spacedBy(8.dp), modifier = Modifier.fillMaxWidth()) {&#10;                item {&#10;                    FilterChip(&#10;                        selected = selectedCategoryId == null,&#10;                        onClick = { selectedCategoryId = null },&#10;                        label = { Text(allLabel) }&#10;                    )&#10;                }&#10;                items(remoteCategories.size) { index -&gt;&#10;                    val cat = remoteCategories[index]&#10;                    FilterChip(&#10;                        selected = selectedCategoryId == cat.id,&#10;                        onClick = { selectedCategoryId = cat.id },&#10;                        label = { Text(cat.name) }&#10;                    )&#10;                }&#10;            }&#10;&#10;            HorizontalDivider()&#10;&#10;            LazyColumn(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .weight(1f),&#10;                verticalArrangement = Arrangement.spacedBy(8.dp),&#10;                contentPadding = androidx.compose.foundation.layout.PaddingValues(bottom = 88.dp)&#10;            ) {&#10;                if (remoteProducts.isEmpty()) {&#10;                    item { Text(noProductsLabel, style = MaterialTheme.typography.bodyMedium) }&#10;                } else {&#10;                    items(remoteProducts.size, key = { idx -&gt; remoteProducts[idx].id ?: idx.toLong() }) { i -&gt;&#10;                        val p = remoteProducts[i]&#10;                        val dismissState = rememberSwipeToDismissBoxState(&#10;                            confirmValueChange = { target -&gt;&#10;                                if (target == SwipeToDismissBoxValue.EndToStart) {&#10;                                    scope.launch {&#10;                                        val id = p.id ?: return@launch&#10;                                        val res = runCatching { catalogRepository.deleteProduct(id) }&#10;                                        if (res.isFailure) {&#10;                                            snack.showSnackbar(res.exceptionOrNull()?.message ?: deleteErrorLabel)&#10;                                        } else {&#10;                                            remoteProducts = remoteProducts.filterNot { it.id == id }&#10;                                        }&#10;                                    }&#10;                                    true&#10;                                } else {&#10;                                    false&#10;                                }&#10;                            }&#10;                        )&#10;                        SwipeToDismissBox(&#10;                            state = dismissState,&#10;                            enableDismissFromStartToEnd = false,&#10;                            enableDismissFromEndToStart = true,&#10;                            backgroundContent = {&#10;                                val fgColor = MaterialTheme.colorScheme.onErrorContainer&#10;                                Box(&#10;                                    modifier = Modifier&#10;                                        .fillMaxWidth()&#10;                                        .heightIn(min = 56.dp)&#10;                                        .background(MaterialTheme.colorScheme.errorContainer)&#10;                                        .padding(vertical = 0.dp),&#10;                                    contentAlignment = Alignment.CenterEnd&#10;                                ) {&#10;                                    Row(&#10;                                        Modifier&#10;                                            .fillMaxWidth()&#10;                                            .padding(horizontal = 16.dp),&#10;                                        horizontalArrangement = Arrangement.End&#10;                                    ) {&#10;                                        Icon(&#10;                                            Icons.Filled.Delete,&#10;                                            contentDescription = null,&#10;                                            tint = fgColor&#10;                                        )&#10;                                    }&#10;                                }&#10;                            }&#10;                        ) {&#10;                            ProductCard(&#10;                                product = p,&#10;                                editLabel = editLabel,&#10;                                deleteLabel = deleteLabel,&#10;                                onEdit = { editingProductId = p.id },&#10;                                onDelete = {&#10;                                    scope.launch {&#10;                                        val id = p.id ?: return@launch&#10;                                        val res = runCatching { catalogRepository.deleteProduct(id) }&#10;                                        if (res.isFailure) {&#10;                                            snack.showSnackbar(res.exceptionOrNull()?.message ?: deleteErrorLabel)&#10;                                        } else {&#10;                                            remoteProducts = remoteProducts.filterNot { it.id == id }&#10;                                        }&#10;                                    }&#10;                                }&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    if (showCreate) {&#10;        var name by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var priceText by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var unit by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var categoryId by rememberSaveable { mutableStateOf&lt;Long?&gt;(null) }&#10;        var categoryInput by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var busy by remember { mutableStateOf(false) }&#10;        val valid = name.isNotBlank() &amp;&amp; (priceText.toDoubleOrNull() != null) &amp;&amp; unit.isNotBlank() &amp;&amp; (categoryId != null || categoryInput.isNotBlank())&#10;&#10;        AlertDialog(&#10;            onDismissRequest = { if (!busy) showCreate = false },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    scope.launch {&#10;                        busy = true&#10;                        try {&#10;                            val finalCategoryId = categoryId ?: catalogRepository.createOrFindCategoryByName(categoryInput)&#10;                            catalogRepository.createProduct(name.trim(), priceText.toDouble(), unit.trim(), finalCategoryId)&#10;                            showCreate = false&#10;                            remoteProducts = catalogRepository.searchProducts(query, selectedCategoryId)&#10;                            remoteCategories = catalogRepository.categoriesForQuery(query)&#10;                        } catch (t: Throwable) {&#10;                            snack.showSnackbar(t.message ?: createErrorLabel)&#10;                        } finally { busy = false }&#10;                    }&#10;                }, enabled = valid &amp;&amp; !busy) { Text(stringResource(id = R.string.create)) }&#10;            },&#10;            dismissButton = { TextButton(onClick = { if (!busy) showCreate = false }) { Text(stringResource(id = R.string.cancel)) } },&#10;            title = { Text(stringResource(id = R.string.new_product)) },&#10;            text = {&#10;                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    OutlinedTextField(value = name, onValueChange = { name = it }, label = { Text(stringResource(id = R.string.name_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = priceText, onValueChange = { priceText = it }, label = { Text(stringResource(id = R.string.price_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = unit, onValueChange = { unit = it }, label = { Text(stringResource(id = R.string.unit_label)) }, singleLine = true)&#10;                    var expanded by remember { mutableStateOf(false) }&#10;                    ExposedDropdownMenuBox(expanded = expanded, onExpandedChange = { expanded = it }) {&#10;                        OutlinedTextField(&#10;                            value = if (categoryId != null) remoteCategories.firstOrNull { it.id == categoryId }?.name ?: categoryInput else categoryInput,&#10;                            onValueChange = { input -&gt; categoryInput = input; categoryId = null },&#10;                            label = { Text(stringResource(id = R.string.category_label)) },&#10;                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded) },&#10;                            modifier = Modifier.menuAnchor().fillMaxWidth()&#10;                        )&#10;                        ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {&#10;                            remoteCategories.forEach { c -&gt;&#10;                                DropdownMenuItem(text = { Text(c.name) }, onClick = { categoryId = c.id; categoryInput = &quot;&quot;; expanded = false })&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        )&#10;    }&#10;&#10;    remoteProducts.firstOrNull { it.id == editingProductId }?.let { prod -&gt;&#10;        var name by rememberSaveable { mutableStateOf(prod.name) }&#10;        var priceText by rememberSaveable {&#10;            val price = prod.metadata.doubleValue(&quot;price&quot;)&#10;            mutableStateOf(price.toString())&#10;        }&#10;        var unit by rememberSaveable { mutableStateOf(prod.metadata.stringValue(&quot;unit&quot;)) }&#10;        var categoryId by rememberSaveable { mutableStateOf&lt;Long?&gt;(prod.category?.id) }&#10;        var categoryInput by rememberSaveable { mutableStateOf(&quot;&quot;) }&#10;        var busy by remember { mutableStateOf(false) }&#10;        val valid = name.isNotBlank() &amp;&amp; (priceText.toDoubleOrNull() != null) &amp;&amp; (categoryId != null || categoryInput.isNotBlank())&#10;&#10;        AlertDialog(&#10;            onDismissRequest = { if (!busy) editingProductId = null },&#10;            confirmButton = {&#10;                TextButton(onClick = {&#10;                    scope.launch {&#10;                        busy = true&#10;                        try {&#10;                            val finalCategoryId = categoryId ?: catalogRepository.createOrFindCategoryByName(categoryInput)&#10;                            catalogRepository.updateProduct(prod.id, name.trim(), priceText.toDouble(), unit.trim(), finalCategoryId)&#10;                            editingProductId = null&#10;                            remoteProducts = catalogRepository.searchProducts(query, selectedCategoryId)&#10;                            remoteCategories = catalogRepository.categoriesForQuery(query)&#10;                        } catch (t: Throwable) {&#10;                            snack.showSnackbar(t.message ?: createErrorLabel)&#10;                        } finally { busy = false }&#10;                    }&#10;                }, enabled = valid &amp;&amp; !busy) { Text(stringResource(id = R.string.save_changes)) }&#10;            },&#10;            dismissButton = { TextButton(onClick = { if (!busy) editingProductId = null }) { Text(stringResource(id = R.string.cancel)) } },&#10;            title = { Text(stringResource(id = R.string.new_product)) },&#10;            text = {&#10;                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {&#10;                    OutlinedTextField(value = name, onValueChange = { name = it }, label = { Text(stringResource(id = R.string.name_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = priceText, onValueChange = { priceText = it }, label = { Text(stringResource(id = R.string.price_label)) }, singleLine = true)&#10;                    OutlinedTextField(value = unit, onValueChange = { unit = it }, label = { Text(stringResource(id = R.string.unit_label)) }, singleLine = true)&#10;                    var expanded by remember { mutableStateOf(false) }&#10;                    ExposedDropdownMenuBox(expanded = expanded, onExpandedChange = { expanded = it }) {&#10;                        OutlinedTextField(&#10;                            value = if (categoryId != null) remoteCategories.firstOrNull { it.id == categoryId }?.name ?: categoryInput else categoryInput,&#10;                            onValueChange = { input -&gt; categoryInput = input; categoryId = null },&#10;                            label = { Text(stringResource(id = R.string.category_label)) },&#10;                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded) },&#10;                            modifier = Modifier.menuAnchor().fillMaxWidth()&#10;                        )&#10;                        ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {&#10;                            remoteCategories.forEach { c -&gt;&#10;                                DropdownMenuItem(text = { Text(c.name) }, onClick = { categoryId = c.id; categoryInput = &quot;&quot;; expanded = false })&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun ProductCard(&#10;    product: ProductDto,&#10;    editLabel: String,&#10;    deleteLabel: String,&#10;    onEdit: () -&gt; Unit,&#10;    onDelete: () -&gt; Unit&#10;) {&#10;    val priceVal = product.metadata.doubleValue(&quot;price&quot;)&#10;    val priceStr = &quot;%.2f&quot;.format(priceVal)&#10;&#10;    Card(&#10;        modifier = Modifier.fillMaxWidth(),&#10;        shape = RoundedCornerShape(12.dp),&#10;        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)&#10;    ) {&#10;        Row(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(12.dp),&#10;            verticalAlignment = Alignment.CenterVertically,&#10;            horizontalArrangement = Arrangement.SpaceBetween&#10;        ) {&#10;            Column(modifier = Modifier.weight(1f)) {&#10;                Text(&#10;                    text = product.name,&#10;                    fontWeight = FontWeight.Bold&#10;                )&#10;                Text(&#10;                    text = &quot;${&quot;$&quot;}${priceStr} c/u&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = Color.Gray&#10;                )&#10;            }&#10;            Spacer(Modifier.width(8.dp))&#10;            Row(verticalAlignment = Alignment.CenterVertically) {&#10;                IconButton(onClick = onEdit) {&#10;                    Icon(&#10;                        imageVector = Icons.Filled.Edit,&#10;                        contentDescription = editLabel,&#10;                        tint = MaterialTheme.colorScheme.primary&#10;                    )&#10;                }&#10;                IconButton(onClick = onDelete) {&#10;                    Icon(&#10;                        imageVector = Icons.Filled.Delete,&#10;                        contentDescription = deleteLabel,&#10;                        tint = MaterialTheme.colorScheme.error&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;private fun JsonElement?.doubleValue(key: String, default: Double = 0.0): Double =&#10;    this?.jsonObject?.get(key)?.jsonPrimitive?.doubleOrNull ?: default&#10;&#10;private fun JsonElement?.stringValue(key: String): String =&#10;    this?.jsonObject?.get(key)?.jsonPrimitive?.contentOrNull.orEmpty()" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>